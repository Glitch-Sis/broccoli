<!DOCTYPE html>
<html lang="de">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Sport Challenge App</title>
Â  Â  <!-- Tailwind CSS CDN fÃ¼r das Styling -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <!-- Konfiguration fÃ¼r Tailwind CSS -->
Â  Â  <script>
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  primary: '#3b82f6', // Blau
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  secondary: '#ef4444', // Rot
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accent: '#22c55e', // GrÃ¼n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sans: ['Inter', 'sans-serif'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%);
Â  Â  Â  Â  Â  Â  color: #f3f4f6;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card {
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease-in-out;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar-fill {
Â  Â  Â  Â  Â  Â  transition: width 0.5s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .animate-pulse-slow {
Â  Â  Â  Â  Â  Â  animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes pulse-slow {
Â  Â  Â  Â  Â  Â  0%, 100% {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  50% {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: .5;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  .toast-container {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 1rem;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 0.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .toast {
Â  Â  Â  Â  Â  Â  padding: 0.75rem 1.5rem;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  animation: fadeinout 4s forwards;
Â  Â  Â  Â  Â  Â  min-width: 250px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .toast-success { background-color: #22c55e; }
Â  Â  Â  Â  .toast-error { background-color: #ef4444; }
Â  Â  Â  Â  .toast-info { background-color: #3b82f6; }
Â  Â  Â  Â  @keyframes fadeinout {
Â  Â  Â  Â  Â  Â  0% { opacity: 0; transform: translateY(20px); }
Â  Â  Â  Â  Â  Â  10% { opacity: 1; transform: translateY(0); }
Â  Â  Â  Â  Â  Â  90% { opacity: 1; transform: translateY(0); }
Â  Â  Â  Â  Â  Â  100% { opacity: 0; transform: translateY(-20px); }
Â  Â  Â  Â  }
Â  Â  </style>

Â  Â  <!-- Firebase JS SDKs -->
Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
Â  Â  Â  Â Â 
Â  Â  Â  Â  (async function() {
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // Globale Variablen und UI-Elemente
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  const SPORT_WEIGHTS = {
Â  Â  Â  Â  Â  Â  Â  Â  'Laufen': 1.5,
Â  Â  Â  Â  Â  Â  Â  Â  'Schwimmen': 1.8,
Â  Â  Â  Â  Â  Â  Â  Â  'Radfahren': 1.2,
Â  Â  Â  Â  Â  Â  Â  Â  'Krafttraining': 1.3,
Â  Â  Â  Â  Â  Â  Â  Â  'Yoga': 0.8,
Â  Â  Â  Â  Â  Â  Â  Â  'Wandern': 0.9,
Â  Â  Â  Â  Â  Â  Â  Â  'Step Aerobic': 1.6,
Â  Â  Â  Â  Â  Â  Â  Â  'HIIT': 1.7,
Â  Â  Â  Â  Â  Â  Â  Â  'Kayaking': 1.1,
Â  Â  Â  Â  Â  Â  Â  Â  'Andere': 1.0
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const GOAL_MINUTES = 8000;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const appContainer = document.getElementById('app-container');
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('message-modal');
Â  Â  Â  Â  Â  Â  const modalContentWrapper = document.getElementById('modal-content-wrapper');
Â  Â  Â  Â  Â  Â  const toastContainer = document.getElementById('toast-container');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let userId;
Â  Â  Â  Â  Â  Â  let currentUser;
Â  Â  Â  Â  Â  Â  let displayedUserId;
Â  Â  Â  Â  Â  Â  let myProgressView = 'minutes';
Â  Â  Â  Â  Â  Â  let chartTimeframe = 'week';
Â  Â  Â  Â  Â  Â  let allSports = { ...SPORT_WEIGHTS };
Â  Â  Â  Â  Â  Â  let editingDocId = null;
Â  Â  Â  Â  Â  Â  let isAppReady = false;

Â  Â  Â  Â  Â  Â  // Speichert die aktuell geladenen Daten
Â  Â  Â  Â  Â  Â  let entries = [];
Â  Â  Â  Â  Â  Â  let leaderboardParticipants = [];

Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // Firebase Konfiguration und Initialisierung
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  const firebaseConfigFromStorage = localStorage.getItem('firebaseConfig');
Â  Â  Â  Â  Â  Â  const firebaseConfig = firebaseConfigFromStorageÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? JSON.parse(firebaseConfigFromStorage)Â 
Â  Â  Â  Â  Â  Â  Â  Â  : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â  Â  Â  Â  Â  Â  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let app = null;
Â  Â  Â  Â  Â  Â  let auth = null;
Â  Â  Â  Â  Â  Â  let db = null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (firebaseConfig.projectId) {
Â  Â  Â  Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /** Zeigt das Modal zur Eingabe der Firebase-Konfiguration an */
Â  Â  Â  Â  Â  Â  function showConfigModal() {
Â  Â  Â  Â  Â  Â  Â  Â  modalContentWrapper.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-primary mb-4">Firebase Konfiguration</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-300 mb-4">Bitte geben Sie Ihre Firebase-Konfiguration als JSON ein, um fortzufahren.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="config-input" rows="10" class="w-full p-2 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="{
Â  &quot;apiKey&quot;: &quot;...&quot;,
Â  &quot;authDomain&quot;: &quot;...&quot;,
Â  &quot;projectId&quot;: &quot;...&quot;,
Â  &quot;storageBucket&quot;: &quot;...&quot;,
Â  &quot;messagingSenderId&quot;: &quot;...&quot;,
Â  &quot;appId&quot;: &quot;...&quot;
}"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="save-config-btn" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors mt-4">Speichern und neu laden</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="config-error" class="text-secondary text-sm mt-2 hidden"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('save-config-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const configInput = document.getElementById('config-input').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('config-error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parsedConfig = JSON.parse(configInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('firebaseConfig', JSON.stringify(parsedConfig));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'UngÃ¼ltiges JSON-Format. Bitte Ã¼berprÃ¼fen Sie Ihre Eingabe.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /** Zeigt eine Toast-Benachrichtigung an */
Â  Â  Â  Â  Â  Â  function showToast(message, type = 'info') {
Â  Â  Â  Â  Â  Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  toast.className = `toast toast-${type}`;
Â  Â  Â  Â  Â  Â  Â  Â  toast.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  toastContainer.appendChild(toast);

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toast.remove();
Â  Â  Â  Â  Â  Â  Â  Â  }, 4000);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // Firebase-Datenbank-Funktionen
Â  Â  Â  Â  Â  Â  // =====================================

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Ruft die SporteintrÃ¤ge eines Benutzers aus Firestore ab.
Â  Â  Â  Â  Â  Â  Â * @param {string} uid - Die Benutzer-ID.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function getSportEntries(uid) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firestore-Instanz ist nicht verfÃ¼gbar.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const privateEntriesPath = `/artifacts/${appId}/users/${uid}/sportEntries`;
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collection(db, privateEntriesPath));
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  const entries = [];
Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entries.push({ id: doc.id, ...doc.data() });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return entries;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * FÃ¼gt einen neuen Sporteintrag in Firestore hinzu.
Â  Â  Â  Â  Â  Â  Â * @param {object} entry - Das hinzuzufÃ¼gende Datenobjekt.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function addSportEntry(entry) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, privateEntriesPath), entry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateLeaderboardStats(userId, currentUser);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Sporteintrag hinzugefÃ¼gt!", "success");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim HinzufÃ¼gen des Dokuments: ", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Fehler beim HinzufÃ¼gen des Eintrags.", "error");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * LÃ¶scht einen Sporteintrag aus Firestore.
Â  Â  Â  Â  Â  Â  Â * @param {string} docId - Die ID des zu lÃ¶schenden Dokuments.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function deleteSportEntry(docId) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, privateEntriesPath, docId));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateLeaderboardStats(userId, currentUser);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Eintrag gelÃ¶scht.", "info");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim LÃ¶schen des Dokuments: ", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Fehler beim LÃ¶schen des Eintrags.", "error");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Aktualisiert einen bestehenden Sporteintrag in Firestore.
Â  Â  Â  Â  Â  Â  Â * @param {string} docId - Die ID des zu aktualisierenden Dokuments.
Â  Â  Â  Â  Â  Â  Â * @param {object} newEntry - Die aktualisierten Daten.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function updateSportEntry(docId, newEntry) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, privateEntriesPath, docId), newEntry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateLeaderboardStats(userId, currentUser);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Eintrag aktualisiert.", "success");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim Aktualisieren des Dokuments: ", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Fehler beim Aktualisieren des Eintrags.", "error");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Ruft benutzerdefinierte Sportarten aus Firestore ab.
Â  Â  Â  Â  Â  Â  Â * @param {string} uid - Die Benutzer-ID.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function getUserDefinedSports(uid) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firestore-Instanz ist nicht verfÃ¼gbar.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return SPORT_WEIGHTS;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const privateSportsPath = `/artifacts/${appId}/users/${uid}/userDefinedSports/sportsDoc`;
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, privateSportsPath);
Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(docRef);
Â  Â  Â  Â  Â  Â  Â  Â  return docSnap.exists() ? docSnap.data().sports : {};
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Speichert benutzerdefinierte Sportarten in Firestore.
Â  Â  Â  Â  Â  Â  Â * @param {object} sports - Das Objekt mit Sportarten und Gewichtungen.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function saveUserDefinedSports(sports) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateSportsPath = `/artifacts/${appId}/users/${userId}/userDefinedSports/sportsDoc`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, privateSportsPath), { sports });
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim Speichern der Sportarten: ", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Ruft die Leaderboard-Daten aus Firestore ab.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function getLeaderboard() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firestore-Instanz ist nicht verfÃ¼gbar.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const publicLeaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collection(db, publicLeaderboardPath));
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  const participants = [];
Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  participants.push({ id: doc.id, ...doc.data() });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return participants;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Aktualisiert die Statistiken eines Benutzers im Ã¶ffentlichen Leaderboard.
Â  Â  Â  Â  Â  Â  Â * @param {string} uid - Die Benutzer-ID.
Â  Â  Â  Â  Â  Â  Â * @param {string} nickname - Der Spitzname des Benutzers.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  async function updateLeaderboardStats(uid, nickname) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateEntriesPath = `/artifacts/${appId}/users/${uid}/sportEntries`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collection(db, privateEntriesPath));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalMinutes = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalWeightedMinutes = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sportsData = allSports;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entry = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weight = sportsData[entry.sport] || 1.0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalMinutes += entry.minutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalWeightedMinutes += entry.minutes * weight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const publicDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(publicDocRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nickname: nickname,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minutes: totalMinutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weightedMinutes: totalWeightedMinutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdated: new Date()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, { merge: true });

Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim Aktualisieren des Leaderboards:", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /** LÃ¤dt alle notwendigen Daten aus der DB und aktualisiert die UI */
Â  Â  Â  Â  Â  Â  async function loadAllData() {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `<p class="text-center text-slate-400">Lade App-Daten...</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entries = await getSportEntries(userId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSports = { ...SPORT_WEIGHTS, ...(await getUserDefinedSports(userId)) };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leaderboardParticipants = await getLeaderboard();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim Laden der App-Daten: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("Fehler", "Daten konnten nicht geladen werden. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // UI Rendering und Update Funktionen
Â  Â  Â  Â  Â  Â  // =====================================

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Zeigt ein dynamisches modales Fenster mit anpassbarem Titel, Nachricht und Buttons an.
Â  Â  Â  Â  Â  Â  Â * @param {string} title - Der Titel des Modals.
Â  Â  Â  Â  Â  Â  Â * @param {string} message - Die Nachricht des Modals.
Â  Â  Â  Â  Â  Â  Â * @param {Array<Object>} buttons - Ein Array von Button-Konfigurationsobjekten.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  function showDynamicModal(title, message, buttons) {
Â  Â  Â  Â  Â  Â  Â  Â  modalContentWrapper.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-2 ${title.includes("Fehler") || title.includes("lÃ¶schen") ? 'text-secondary' : 'text-primary'}">${title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-300 mb-4">${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end gap-2 mt-4" id="modal-buttons"></div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  const buttonContainer = document.getElementById('modal-buttons');
Â  Â  Â  Â  Â  Â  Â  Â  buttons.forEach(btnConfig => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.id = btnConfig.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = btnConfig.text;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.className = btnConfig.class;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.addEventListener('click', btnConfig.onClick);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buttonContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /** Rendert das Anmeldeformular fÃ¼r den Spitznamen. */
Â  Â  Â  Â  Â  Â  function renderNicknameForm() {
Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center p-6 bg-slate-700 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold mb-4 text-white">Willkommen!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-300 mb-4">Geben Sie Ihren Spitznamen ein, um zu beginnen.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="nickname-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="nickname-input" placeholder="Ihr Spitzname" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Starten</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  const nicknameForm = document.getElementById('nickname-form');
Â  Â  Â  Â  Â  Â  Â  Â  const nicknameInput = document.getElementById('nickname-input');
Â  Â  Â  Â  Â  Â  Â  Â  nicknameForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nickname = nicknameInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (nickname) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = nickname;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId), { nickname: currentUser }, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAppReady = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("UngÃ¼ltiger Spitzname", "Bitte geben Sie einen gÃ¼ltigen Spitznamen ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /** Rendert die Haupt-App. */
Â  Â  Â  Â  Â  Â  function renderApp() {
Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow w-full max-w-4xl mx-auto space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Navigationsleiste -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <nav class="bg-slate-700 rounded-xl p-2 flex flex-col sm:flex-row justify-start gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-section="dashboard" class="nav-button bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Dashboard</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-section="add-entry" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Sportart eintragen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-section="add-sport" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Neue Sportart erstellen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Abschnitt fÃ¼r das Dashboard -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="dashboard-section" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Teilnehmer Abschnitt -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card bg-slate-700 p-6 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-4">Teilnehmer</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="leaderboard" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Die Rangliste wird hier geladen -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Fortschritt Abschnitt -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card bg-slate-700 p-6 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white">Fortschritt</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between mb-2 text-sm text-slate-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="my-progress-label">Gesammelte Minuten</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="my-progress-value">0</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-progress-btn" class="text-sm text-slate-400 py-1 px-3 rounded-full border border-slate-600 hover:bg-slate-600 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Umschalten
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Fortschrittsbalken -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-6 bg-slate-800 rounded-full overflow-hidden mb-4 shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="progress-bar" class="h-full bg-accent progress-bar-fill rounded-full" style="width: 0%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="progress-text" class="text-center text-sm font-semibold text-slate-400"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-white mb-2">AktivitÃ¤t</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-center gap-2 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-timeframe="week" class="timeframe-btn bg-primary text-white font-semibold py-1 px-3 rounded-full hover:bg-blue-700 transition-colors">Woche</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-timeframe="month" class="timeframe-btn bg-slate-600 text-white font-semibold py-1 px-3 rounded-full hover:bg-slate-500 transition-colors">Monat</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-timeframe="year" class="timeframe-btn bg-slate-600 text-white font-semibold py-1 px-3 rounded-full hover:bg-slate-500 transition-colors">Jahr</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="weekly-chart" class="w-full h-48"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Minuten pro Sportart Auswertung -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card bg-slate-700 p-6 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-4">Minuten pro Sportart</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="sport-summary-list" class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Der Inhalt wird hier geladen -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Letzte AktivitÃ¤ten Abschnitt -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card bg-slate-700 p-6 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-4">Letzte AktivitÃ¤ten</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="recent-activities" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Die AktivitÃ¤ten werden hier geladen -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Abschnitt zum Eintragen von Sport -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="add-entry-section" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card bg-slate-700 p-6 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-4">Sportart hinzufÃ¼gen</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="add-entry-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="sport-select" class="block text-slate-300 font-semibold mb-1">Sportart</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="sport-select" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Sportarten werden hier dynamisch geladen -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="date-input" class="block text-slate-300 font-semibold mb-1">Datum</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="date-input" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="minutes-input" class="block text-slate-300 font-semibold mb-1">Minuten</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="minutes-input" value="0" min="0" class="w-full p-3 rounded-lg bg-slate-800 text-white text-center text-lg font-bold border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 grid grid-cols-3 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-minutes="5" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+5</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-minutes="10" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+10</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-minutes="15" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+15</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-minutes="30" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+30</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-minutes="60" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+60</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="clear-minutes-btn" class="w-full bg-secondary text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition-colors">LÃ¶schen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Eintrag hinzufÃ¼gen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Abschnitt zum HinzufÃ¼gen eigener Sportarten -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="add-sport-section" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card bg-slate-700 p-6 rounded-xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-4">Eigene Sportart hinzufÃ¼gen</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="add-sport-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-sport-name" class="block text-slate-300 font-semibold mb-1">Name der Sportart</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="new-sport-name" placeholder="z.B. Boxen" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-sport-weight" class="block text-slate-300 font-semibold mb-1">Gewichtung (z.B. 1.5)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.1" id="new-sport-weight" placeholder="z.B. 1.5" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Sportart hinzufÃ¼gen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-white mb-2">Aktuelle Sportarten und GewichtungenÂ </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="sport-weight-list" class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Die Liste wird hier geladen -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  const dateInput = document.getElementById('date-input');
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  dateInput.value = today;

Â  Â  Â  Â  Â  Â  Â  Â  setupEventListeners();
Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Zeigt einen bestimmten Abschnitt an und verbirgt die anderen.
Â  Â  Â  Â  Â  Â  Â * @param {string} sectionId - Die ID des anzuzeigenden Abschnitts.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  function showSection(sectionId) {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.nav-button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isSelected = btn.dataset.section === sectionId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('bg-primary', isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('hover:bg-blue-700', isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('bg-slate-600', !isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('hover:bg-slate-500', !isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dashboard-section').classList.toggle('hidden', sectionId !== 'dashboard');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-entry-section').classList.toggle('hidden', sectionId !== 'add-entry');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-sport-section').classList.toggle('hidden', sectionId !== 'add-sport');

Â  Â  Â  Â  Â  Â  Â  Â  if (sectionId === 'dashboard') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /** Rendert das Dashboard mit den aktuellen Daten */
Â  Â  Â  Â  Â  Â  function renderDashboard() {
Â  Â  Â  Â  Â  Â  Â  Â  // Filtere EintrÃ¤ge basierend auf dem aktuell angezeigten Benutzer
Â  Â  Â  Â  Â  Â  Â  Â  const displayedUserEntries = entries.filter(entry => entry.userId === displayedUserId);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  renderMyProgress(displayedUserEntries);
Â  Â  Â  Â  Â  Â  Â  Â  renderSportSummary(displayedUserEntries);
Â  Â  Â  Â  Â  Â  Â  Â  renderRecentActivities(displayedUserEntries);
Â  Â  Â  Â  Â  Â  Â  Â  renderLeaderboard(leaderboardParticipants);
Â  Â  Â  Â  Â  Â  Â  Â  renderSportSelect();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // UI Rendering und Update Funktionen (Fortsetzung)
Â  Â  Â  Â  Â  Â  // =====================================

Â  Â  Â  Â  Â  Â  /** Rendert die Sportarten-Dropdown-Liste neu */
Â  Â  Â  Â  Â  Â  function renderSportSelect() {
Â  Â  Â  Â  Â  Â  Â  Â  const sportSelect = document.getElementById('sport-select');
Â  Â  Â  Â  Â  Â  Â  Â  if (sportSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sportSelect.innerHTML = Object.keys(allSports).map(sport =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<option value="${sport}">${sport}</option>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ).join('');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /** Rendert die Liste der Sportarten und ihrer Gewichtungen. */
Â  Â  Â  Â  Â  Â  function renderSportWeightList() {
Â  Â  Â  Â  Â  Â  Â  Â  const sportWeightListEl = document.getElementById('sport-weight-list');
Â  Â  Â  Â  Â  Â  Â  Â  if (!sportWeightListEl) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  sportWeightListEl.innerHTML = Object.entries(allSports).map(([sport, weight]) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-white font-semibold">${sport}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-primary font-bold">Gewichtung: ${weight}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /** Zeigt den Fortschritt eines bestimmten Benutzers an. */
Â  Â  Â  Â  Â  Â  async function showUserProgress(selectedUserId) {
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedUserId === displayedUserId) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Lade Daten fÃ¼r ${leaderboardParticipants.find(p => p.id === selectedUserId)?.nickname || 'den Benutzer'}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  entries = await getSportEntries(selectedUserId);
Â  Â  Â  Â  Â  Â  Â  Â  allSports = { ...SPORT_WEIGHTS, ...(await getUserDefinedSports(selectedUserId)) };

Â  Â  Â  Â  Â  Â  Â  Â  displayedUserId = selectedUserId;
Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function renderMyProgress(myEntries) {
Â  Â  Â  Â  Â  Â  Â  Â  const myProgressLabelEl = document.getElementById('my-progress-label');
Â  Â  Â  Â  Â  Â  Â  Â  const myProgressValueEl = document.getElementById('my-progress-value');
Â  Â  Â  Â  Â  Â  Â  Â  const progressBarEl = document.getElementById('progress-bar');
Â  Â  Â  Â  Â  Â  Â  Â  const progressTextEl = document.getElementById('progress-text');

Â  Â  Â  Â  Â  Â  Â  Â  if (!myProgressLabelEl || !myProgressValueEl || !progressBarEl || !progressTextEl || !myEntries) return;

Â  Â  Â  Â  Â  Â  Â  Â  const totalMinutes = myEntries.reduce((sum, entry) => sum + entry.minutes, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const totalWeightedMinutes = myEntries.reduce((sum, entry) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weight = allSports[entry.sport] || 1.0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return sum + (entry.minutes * weight);
Â  Â  Â  Â  Â  Â  Â  Â  }, 0);

Â  Â  Â  Â  Â  Â  Â  Â  let displayValue = (myProgressView === 'minutes') ? totalMinutes : totalWeightedMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  let progress = (displayValue / GOAL_MINUTES) * 100;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  myProgressLabelEl.textContent = (myProgressView === 'minutes') ? 'Gesammelte Minuten' : 'Gewichtete Minuten';
Â  Â  Â  Â  Â  Â  Â  Â  myProgressValueEl.textContent = displayValue.toFixed(myProgressView === 'weighted' ? 1 : 0);
Â  Â  Â  Â  Â  Â  Â  Â  progressBarEl.style.width = `${Math.min(100, progress)}%`;
Â  Â  Â  Â  Â  Â  Â  Â  progressTextEl.textContent = `Fortschritt: ${progress.toFixed(1)}%`;

Â  Â  Â  Â  Â  Â  Â  Â  if (progress >= 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressBarEl.classList.remove('bg-accent');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressBarEl.classList.add('bg-primary', 'animate-pulse-slow');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressTextEl.textContent = "Ziel erreicht! Herzlichen GlÃ¼ckwunsch! ðŸŽ‰";
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressBarEl.classList.remove('bg-primary', 'animate-pulse-slow');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progressBarEl.classList.add('bg-accent');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  renderWeeklyProgressGraph(myEntries);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function renderWeeklyProgressGraph(myEntries) {
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.getElementById('weekly-chart');
Â  Â  Â  Â  Â  Â  Â  Â  if (!canvas || !myEntries) return;

Â  Â  Â  Â  Â  Â  Â  Â  const containerWidth = canvas.parentElement.clientWidth;
Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = containerWidth;
Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = 192;

Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let dataPoints = [];
Â  Â  Â  Â  Â  Â  Â  Â  let labels = [];

Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  // Funktion zum Abrufen des korrekten Datumsobjekts (Firestore Timestamp oder JS Date)
Â  Â  Â  Â  Â  Â  Â  Â  const getEntryDate = (entry) => entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);

Â  Â  Â  Â  Â  Â  Â  Â  if (chartTimeframe === 'week') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dailyMinutes = new Array(7).fill(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oneWeekAgo = now.getTime() - 7 * 24 * 60 * 60 * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myEntries.filter(entry => getEntryDate(entry).getTime() > oneWeekAgo)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .forEach(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entryDate = getEntryDate(entry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffDays = Math.floor((now.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffDays >= 0 && diffDays < 7) dailyMinutes[6 - diffDays] += entry.minutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataPoints = dailyMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 6; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(now);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date.setDate(now.getDate() - i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels.push(date.toLocaleDateString('de-DE', { weekday: 'short' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (chartTimeframe === 'month') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weeklyMinutes = new Array(4).fill(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oneMonthAgo = now.getTime() - 30 * 24 * 60 * 60 * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myEntries.filter(entry => getEntryDate(entry).getTime() > oneMonthAgo)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .forEach(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entryDate = getEntryDate(entry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffDays = Math.floor((now.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weekIndex = Math.floor(diffDays / 7);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (weekIndex >= 0 && weekIndex < 4) weeklyMinutes[3 - weekIndex] += entry.minutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataPoints = weeklyMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels = ['Woche 1', 'Woche 2', 'Woche 3', 'Woche 4'];
Â  Â  Â  Â  Â  Â  Â  Â  } else if (chartTimeframe === 'year') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthlyMinutes = new Array(12).fill(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oneYearAgo = now.getTime() - 365 * 24 * 60 * 60 * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myEntries.filter(entry => getEntryDate(entry).getTime() > oneYearAgo)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .forEach(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entryDate = getEntryDate(entry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffMonths = (now.getFullYear() - entryDate.getFullYear()) * 12 + (now.getMonth() - entryDate.getMonth());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffMonths >= 0 && diffMonths < 12) monthlyMinutes[11 - diffMonths] += entry.minutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataPoints = monthlyMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 11; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels.push(monthDate.toLocaleDateString('de-DE', { month: 'short' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const maxMinutes = Math.max(...dataPoints, 1);
Â  Â  Â  Â  Â  Â  Â  Â  const padding = 30;
Â  Â  Â  Â  Â  Â  Â  Â  const chartHeight = canvas.height - 2 * padding;
Â  Â  Â  Â  Â  Â  Â  Â  const chartWidth = canvas.width - 2 * padding;
Â  Â  Â  Â  Â  Â  Â  Â  const pointSpacing = chartWidth / (dataPoints.length > 1 ? dataPoints.length - 1 : 1);

Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#22c55e';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  Â  Â  const points = dataPoints.map((value, index) => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: padding + index * pointSpacing,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: padding + chartHeight - (value / maxMinutes) * chartHeight
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  if (points.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(points[0].x, points[0].y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  points.forEach(point => ctx.lineTo(point.x, point.y));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.textAlign = 'right';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#94a3b8';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '10px Inter';
Â  Â  Â  Â  Â  Â  Â  Â  const yLabels = [0, Math.floor(maxMinutes / 2), maxMinutes];
Â  Â  Â  Â  Â  Â  Â  Â  yLabels.forEach(label => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y = padding + chartHeight - (label / maxMinutes) * chartHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(label, padding - 5, y + 4);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  points.forEach(point => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#22c55e';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#f3f4f6';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '12px Inter';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  labels.forEach((label, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const x = padding + index * pointSpacing;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#94a3b8';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(label, x, canvas.height - 5);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#f3f4f6';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(dataPoints[index], x, points[index].y - 10);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function renderLeaderboard(participants) {
Â  Â  Â  Â  Â  Â  Â  Â  const leaderboardEl = document.getElementById('leaderboard');
Â  Â  Â  Â  Â  Â  Â  Â  if (!leaderboardEl || !participants) return;

Â  Â  Â  Â  Â  Â  Â  Â  let sortedParticipants = [...participants];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Sortiere: Aktueller Benutzer zuerst, dann der Rest (wichtig fÃ¼r die Darstellung)
Â  Â  Â  Â  Â  Â  Â  Â  const loggedInUser = sortedParticipants.find(p => p.id === userId);
Â  Â  Â  Â  Â  Â  Â  Â  sortedParticipants = loggedInUser ? [loggedInUser, ...sortedParticipants.filter(p => p.id !== userId)] : sortedParticipants;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const minutesLeader = [...participants].sort((a, b) => b.minutes - a.minutes)[0] || { minutes: -1, id: null };
Â  Â  Â  Â  Â  Â  Â  Â  const weightedLeader = [...participants].sort((a, b) => b.weightedMinutes - a.weightedMinutes)[0] || { weightedMinutes: -1, id: null };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  leaderboardEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Behalte das korrigierte Grid-Layout bei, um das Layout stabil zu halten -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${sortedParticipants.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isMinutesLeader = p.id === minutesLeader.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isWeightedLeader = p.id === weightedLeader.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isActiveUser = p.id === displayedUserId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div data-user-id="${p.id}" class="p-6 rounded-xl border-2 cursor-pointer transition-all duration-200 ease-in-out ${isActiveUser ? 'border-primary' : 'border-slate-600'} bg-slate-800 text-center relative overflow-hidden hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-2 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.nickname}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.id === userId ? ' (Du)' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg bg-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-400 text-sm">Gesammelte Minuten</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-2xl font-extrabold ${isMinutesLeader ? 'text-primary' : 'text-white'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.minutes.toFixed(0)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isMinutesLeader ? '<span class="text-xs ml-1">ðŸ†</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 rounded-lg bg-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-400 text-sm">Gewichtete Minuten</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-2xl font-extrabold ${isWeightedLeader ? 'text-accent' : 'text-white'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.weightedMinutes.toFixed(1)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isWeightedLeader ? '<span class="text-xs ml-1">ðŸ†</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-slate-500 mt-2">${p.id}</div> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function renderSportSummary(myEntries) {
Â  Â  Â  Â  Â  Â  Â  Â  const summaryEl = document.getElementById('sport-summary-list');
Â  Â  Â  Â  Â  Â  Â  Â  if (!summaryEl || !myEntries) return;

Â  Â  Â  Â  Â  Â  Â  Â  const sportMinutes = {};
Â  Â  Â  Â  Â  Â  Â  Â  myEntries.forEach(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sportName = entry.sport;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!sportMinutes[sportName]) sportMinutes[sportName] = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sportMinutes[sportName] += entry.minutes;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const sortedSports = Object.keys(sportMinutes).sort((a, b) => sportMinutes[b] - sportMinutes[a]);

Â  Â  Â  Â  Â  Â  Â  Â  summaryEl.innerHTML = sortedSports.map(sport => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-white font-semibold">${sport}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-primary font-bold">${sportMinutes[sport]} Minuten</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function renderRecentActivities(myEntries) {
Â  Â  Â  Â  Â  Â  Â  Â  const recentActivitiesEl = document.getElementById('recent-activities');
Â  Â  Â  Â  Â  Â  Â  Â  if (!recentActivitiesEl || !myEntries) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const sortedActivities = myEntries.sort((a, b) => (b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp)) - (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp)));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  recentActivitiesEl.innerHTML = sortedActivities.map(activity => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = activity.timestamp.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateString = date.toLocaleDateString('de-DE');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeString = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isMyEntry = activity.userId === userId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyEntry && activity.id === editingDocId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col p-4 bg-slate-800 rounded-lg border border-primary" data-doc-id="${activity.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-white font-semibold">Eintrag von ${activity.nickname} bearbeiten</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="save" class="text-xs text-accent hover:text-green-400 transition-colors">Speichern</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="cancel" class="text-xs text-secondary hover:text-red-400 transition-colors">Abbrechen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="edit-sport-select" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${Object.keys(allSports).map(sport =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<option value="${sport}" ${sport === activity.sport ? 'selected' : ''}>${sport}</option>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="edit-minutes-input" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm" value="${activity.minutes}" min="1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="edit-date-input" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm" value="${new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().split('T')[0]}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const actionButtons = isMyEntry ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="edit" data-doc-id="${activity.id}" class="text-xs text-slate-400 hover:text-white transition-colors">Bearbeiten</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="delete" data-doc-id="${activity.id}" class="text-xs text-secondary hover:text-red-400 transition-colors">LÃ¶schen</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-white font-semibold">${activity.nickname}</span> hat <span class="text-primary font-bold">${activity.minutes} Minuten</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-accent font-semibold">${activity.sport}</span> gemacht.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-shrink-0 text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-slate-500 block mb-1">${dateString} ${timeString}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // Event-Listener Setup
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function setupEventListeners() {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.nav-button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => showSection(btn.dataset.section));
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-entry-form')?.addEventListener('submit', handleFormSubmit);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('add-sport-form')?.addEventListener('submit', handleAddSportFormSubmit);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('toggle-progress-btn')?.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myProgressView = myProgressView === 'minutes' ? 'weighted' : 'minutes';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.timeframe-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chartTimeframe = btn.dataset.timeframe;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.timeframe-btn').forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isSelected = b.dataset.timeframe === chartTimeframe;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.classList.toggle('bg-primary', isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.classList.toggle('hover:bg-blue-700', isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.classList.toggle('bg-slate-600', !isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.classList.toggle('hover:bg-slate-500', !isSelected);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Event-Delegation fÃ¼r Minuten-Buttons
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#add-entry-section')?.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const target = e.target;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutesInput = document.getElementById('minutes-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (target.classList.contains('minutes-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentMinutes = parseInt(minutesInput.value, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentMinutes += parseInt(target.dataset.minutes, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minutesInput.value = currentMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (target.id === 'clear-minutes-btn') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minutesInput.value = '0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const sportSelect = document.getElementById('sport-select');
Â  Â  Â  Â  Â  Â  Â  Â  if (sportSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sportSelect.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('minutes-input').value = '0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Event-Delegation fÃ¼r die Liste der letzten AktivitÃ¤ten
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recent-activities')?.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const target = e.target;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docId = target.dataset.docId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const action = target.dataset.action;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (action === 'delete') handleDeleteClick(docId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (action === 'edit') handleEditClick(docId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (action === 'save') handleSaveEdit(docId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (action === 'cancel') handleCancelEdit();
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Event-Delegation fÃ¼r die Rangliste
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('leaderboard')?.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const target = e.target.closest('[data-user-id]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (target) showUserProgress(target.dataset.userId);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // Formular-Handling
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  async function handleFormSubmit(e) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const sportSelect = document.getElementById('sport-select');
Â  Â  Â  Â  Â  Â  Â  Â  const dateInput = document.getElementById('date-input');
Â  Â  Â  Â  Â  Â  Â  Â  const minutesInput = document.getElementById('minutes-input');
Â  Â  Â  Â  Â  Â  Â  Â  const sport = sportSelect.value;
Â  Â  Â  Â  Â  Â  Â  Â  const date = dateInput.value;
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = parseInt(minutesInput.value, 10);

Â  Â  Â  Â  Â  Â  Â  Â  if (minutes > 0 && date && userId && currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newEntry = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nickname: currentUser,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sport: sport,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minutes: minutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date(date)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addSportEntry(newEntry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minutesInput.value = '0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSection('dashboard');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("UngÃ¼ltige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  async function handleAddSportFormSubmit(e) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const newSportNameInput = document.getElementById('new-sport-name');
Â  Â  Â  Â  Â  Â  Â  Â  const newSportWeightInput = document.getElementById('new-sport-weight');
Â  Â  Â  Â  Â  Â  Â  Â  const sportName = newSportNameInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const sportWeight = parseFloat(newSportWeightInput.value);

Â  Â  Â  Â  Â  Â  Â  Â  if (sportName && !isNaN(sportWeight) && sportWeight > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userSports = { ...allSports };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userSports[sportName] = sportWeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveUserDefinedSports(userSports);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Sportart hinzugefÃ¼gt!", "success");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newSportNameInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newSportWeightInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderSportWeightList();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("UngÃ¼ltige Eingabe", "Bitte geben Sie einen gÃ¼ltigen Namen und eine positive Zahl fÃ¼r die Gewichtung ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- CRUD-Funktionen fÃ¼r EintrÃ¤ge ---
Â  Â  Â  Â  Â  Â  function handleDeleteClick(docId) {
Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Eintrag lÃ¶schen",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "MÃ¶chten Sie diesen Eintrag wirklich unwiderruflich lÃ¶schen?",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'confirm-yes-btn', text: 'Ja', class: 'bg-secondary text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors', onClick: async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteSportEntry(docId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'confirm-no-btn', text: 'Nein', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function handleEditClick(docId) {
Â  Â  Â  Â  Â  Â  Â  Â  editingDocId = docId;
Â  Â  Â  Â  Â  Â  Â  Â  renderRecentActivities(entries.filter(entry => entry.userId === displayedUserId));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function handleSaveEdit(docId) {
Â  Â  Â  Â  Â  Â  Â  Â  const editedSport = document.getElementById('edit-sport-select').value;
Â  Â  Â  Â  Â  Â  Â  Â  const editedMinutes = parseInt(document.getElementById('edit-minutes-input').value);
Â  Â  Â  Â  Â  Â  Â  Â  const editedDate = document.getElementById('edit-date-input').value;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (editedMinutes > 0 && editedDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newEntry = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sport: editedSport,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minutes: editedMinutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date(editedDate),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateSportEntry(docId, newEntry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editingDocId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("UngÃ¼ltige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function handleCancelEdit() {
Â  Â  Â  Â  Â  Â  Â  Â  editingDocId = null;
Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  // App-Initialisierung
Â  Â  Â  Â  Â  Â  // =====================================
Â  Â  Â  Â  Â  Â  async function migrateDataFromLocalStorage(firebaseUid) {
Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `<p class="text-center text-slate-400">Migriere lokale Daten...</p>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const localStorageUserId = localStorage.getItem('userId');
Â  Â  Â  Â  Â  Â  Â  Â  const localStorageNickname = localStorage.getItem('nickname');
Â  Â  Â  Â  Â  Â  Â  Â  const sportEntriesStr = localStorage.getItem('sportEntries');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!localStorageUserId || !localStorageNickname || !sportEntriesStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Lokalstorage-Daten fehlen. Migration wird Ã¼bersprungen.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await checkUserExistsAndLoad();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entriesToMigrate = JSON.parse(sportEntriesStr).filter(entry =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entry.userId === localStorageUserId && entry.nickname === localStorageNickname
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (entriesToMigrate.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, leaderboardPath, firebaseUid), { nickname: localStorageNickname, migratedFrom: localStorageUserId }, { merge: true });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateEntriesPath = `/artifacts/${appId}/users/${firebaseUid}/sportEntries`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const batchPromises = entriesToMigrate.map(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const firestoreEntry = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...entry,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: firebaseUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nickname: localStorageNickname,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date(entry.timestamp)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return addDoc(collection(db, privateEntriesPath), firestoreEntry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all(batchPromises);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userDefinedSportsStr = localStorage.getItem('userDefinedSports');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userDefinedSportsStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sports = JSON.parse(userDefinedSportsStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const privateSportsPath = `/artifacts/${appId}/users/${firebaseUid}/userDefinedSports/sportsDoc`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, privateSportsPath), { sports });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Lokale Daten erfolgreich migriert!", "success");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Keine zu migrierenden EintrÃ¤ge fÃ¼r diesen Benutzer gefunden.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('userId');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('nickname');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('sportEntries');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('userDefinedSports');

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler bei der Migration:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("Migrationsfehler", "Ein Fehler ist bei der Datenmigration aufgetreten. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function checkUserExistsAndLoad() {
Â  Â  Â  Â  Â  Â  Â  Â  const userDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId);
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userDoc = await getDoc(userDocRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userDoc.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userDoc.data().nickname;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAllData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderNicknameForm();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fehler beim Laden der Benutzerdaten:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("Fehler", "Benutzerdaten konnten nicht geladen werden. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  async function startApp() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!app) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfigModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!auth || !db) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase Auth oder Firestore Instanz nicht initialisiert.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("Initialisierungsfehler", "Firebase konnte nicht richtig geladen werden. ÃœberprÃ¼fen Sie Ihre Konfiguration.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(auth, initialAuthToken);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Authentifizierungsfehler:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDynamicModal("Authentifizierungsfehler", "Konnte mich nicht anmelden. Bitte Ã¼berprÃ¼fen Sie Ihre Internetverbindung.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  userId = auth.currentUser.uid;
Â  Â  Â  Â  Â  Â  Â  Â  displayedUserId = userId;

Â  Â  Â  Â  Â  Â  Â  Â  const hasLocalData = localStorage.getItem('userId') && localStorage.getItem('sportEntries');
Â  Â  Â  Â  Â  Â  Â  Â  if (hasLocalData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await migrateDataFromLocalStorage(userId);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await checkUserExistsAndLoad();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  startApp();
Â  Â  Â  Â  })();
Â  Â  </script>
</head>
<body class="p-4 sm:p-8">
Â  Â  <!-- Hauptcontainer fÃ¼r die gesamte App -->
Â  Â  <div class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl mx-auto border border-slate-700 flex-grow">
Â  Â  Â  Â  <h1 class="text-3xl sm:text-4xl font-bold text-center text-primary mb-2">Sport Challenge 2025/26</h1>
Â  Â  Â  Â  <p class="text-center text-slate-400 mb-6">Erreiche 8000 Minuten Sport in einem Jahr.</p>

Â  Â  Â  Â  <!-- Container fÃ¼r die Anmeldemaske oder die Haupt-App -->
Â  Â  Â  Â  <div id="app-container">
Â  Â  Â  Â  Â  Â  <p class="text-center text-slate-400">Lade App-Daten...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modales Overlay fÃ¼r Warnungen/Meldungen -->
Â  Â  <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
Â  Â  Â  Â  <div id="modal-content-wrapper" class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700">
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Toast Benachrichtigungs-Container -->
Â  Â  <div id="toast-container" class="toast-container"></div>

Â  Â  <!-- Footer Navigation -->
Â  Â  <footer class="mt-8">
Â  Â  </footer>
</body>
</html>

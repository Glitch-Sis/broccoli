<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Challenge App</title>
    <!-- Tailwind CSS CDN für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfiguration für Tailwind CSS -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // Blau
                        secondary: '#ef4444', // Rot
                        accent: '#22c55e', // Grün
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%);
            color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        .card {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .toast-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            color: white;
            opacity: 0;
            animation: fadeinout 4s forwards;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toast-success { background-color: #22c55e; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>

    <!-- Firebase JS SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        (async function() {
            // =====================================
            // Globale Variablen und UI-Elemente
            // =====================================
            const SPORT_WEIGHTS = {
                'Laufen': 1.5,
                'Schwimmen': 1.8,
                'Radfahren': 1.2,
                'Krafttraining': 1.3,
                'Yoga': 0.8,
                'Wandern': 0.9,
                'Step Aerobic': 1.6,
                'HIIT': 1.7,
                'Kayaking': 1.1,
                'Andere': 1.0
            };
            const GOAL_MINUTES = 8000;
            
            const appContainer = document.getElementById('app-container');
            const modal = document.getElementById('message-modal');
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const toastContainer = document.getElementById('toast-container');
            
            let userId;
            let currentUser;
            let displayedUserId;
            let myProgressView = 'minutes';
            let chartTimeframe = 'week';
            let allSports = { ...SPORT_WEIGHTS };
            let editingDocId = null;
            let isAppReady = false;

            // Speichert die aktuell geladenen Daten
            let entries = [];
            let leaderboardParticipants = [];

            // =====================================
            // Firebase Konfiguration und Initialisierung
            // =====================================
            const firebaseConfigFromStorage = localStorage.getItem('firebaseConfig');
            const firebaseConfig = firebaseConfigFromStorage 
                ? JSON.parse(firebaseConfigFromStorage) 
                : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
            
            let app = null;
            let auth = null;
            let db = null;
            
            if (firebaseConfig.projectId) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }

            /** Zeigt das Modal zur Eingabe der Firebase-Konfiguration an */
            function showConfigModal() {
                modalContentWrapper.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-primary mb-4">Firebase Konfiguration</h3>
                        <p class="text-slate-300 mb-4">Bitte geben Sie Ihre Firebase-Konfiguration als JSON ein, um fortzufahren.</p>
                        <textarea id="config-input" rows="10" class="w-full p-2 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="{
  &quot;apiKey&quot;: &quot;...&quot;,
  &quot;authDomain&quot;: &quot;...&quot;,
  &quot;projectId&quot;: &quot;...&quot;,
  &quot;storageBucket&quot;: &quot;...&quot;,
  &quot;messagingSenderId&quot;: &quot;...&quot;,
  &quot;appId&quot;: &quot;...&quot;
}"></textarea>
                        <button id="save-config-btn" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors mt-4">Speichern und neu laden</button>
                        <div id="config-error" class="text-secondary text-sm mt-2 hidden"></div>
                    </div>
                `;
                modal.classList.remove('hidden');

                document.getElementById('save-config-btn').addEventListener('click', () => {
                    const configInput = document.getElementById('config-input').value;
                    const errorEl = document.getElementById('config-error');
                    try {
                        const parsedConfig = JSON.parse(configInput);
                        localStorage.setItem('firebaseConfig', JSON.stringify(parsedConfig));
                        window.location.reload();
                    } catch (e) {
                        errorEl.textContent = 'Ungültiges JSON-Format. Bitte überprüfen Sie Ihre Eingabe.';
                        errorEl.classList.remove('hidden');
                    }
                });
            }
            
            /** Zeigt eine Toast-Benachrichtigung an */
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }

            // =====================================
            // Firebase-Datenbank-Funktionen
            // =====================================

            /**
             * Ruft die Sporteinträge eines Benutzers aus Firestore ab.
             * @param {string} uid - Die Benutzer-ID.
             */
            async function getSportEntries(uid) {
                if (!db) {
                    console.error("Firestore-Instanz ist nicht verfügbar.");
                    return [];
                }
                const privateEntriesPath = `/artifacts/${appId}/users/${uid}/sportEntries`;
                const q = query(collection(db, privateEntriesPath));
                const querySnapshot = await getDocs(q);
                const entries = [];
                querySnapshot.forEach(doc => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                return entries;
            }

            /**
             * Fügt einen neuen Sporteintrag in Firestore hinzu.
             * @param {object} entry - Das hinzuzufügende Datenobjekt.
             */
            async function addSportEntry(entry) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    await addDoc(collection(db, privateEntriesPath), entry);
                    await updateLeaderboardStats(userId, currentUser);
                    showToast("Sporteintrag hinzugefügt!", "success");
                    await loadAllData();
                } catch (e) {
                    console.error("Fehler beim Hinzufügen des Dokuments: ", e);
                    showToast("Fehler beim Hinzufügen des Eintrags.", "error");
                }
            }

            /**
             * Löscht einen Sporteintrag aus Firestore.
             * @param {string} docId - Die ID des zu löschenden Dokuments.
             */
            async function deleteSportEntry(docId) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    await deleteDoc(doc(db, privateEntriesPath, docId));
                    await updateLeaderboardStats(userId, currentUser);
                    showToast("Eintrag gelöscht.", "info");
                    await loadAllData();
                } catch (e) {
                    console.error("Fehler beim Löschen des Dokuments: ", e);
                    showToast("Fehler beim Löschen des Eintrags.", "error");
                }
            }
            
            /**
             * Aktualisiert einen bestehenden Sporteintrag in Firestore.
             * @param {string} docId - Die ID des zu aktualisierenden Dokuments.
             * @param {object} newEntry - Die aktualisierten Daten.
             */
            async function updateSportEntry(docId, newEntry) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    await updateDoc(doc(db, privateEntriesPath, docId), newEntry);
                    await updateLeaderboardStats(userId, currentUser);
                    showToast("Eintrag aktualisiert.", "success");
                    await loadAllData();
                } catch (e) {
                    console.error("Fehler beim Aktualisieren des Dokuments: ", e);
                    showToast("Fehler beim Aktualisieren des Eintrags.", "error");
                }
            }

            /**
             * Ruft benutzerdefinierte Sportarten aus Firestore ab.
             * @param {string} uid - Die Benutzer-ID.
             */
            async function getUserDefinedSports(uid) {
                if (!db) {
                    console.error("Firestore-Instanz ist nicht verfügbar.");
                    return SPORT_WEIGHTS;
                }
                const privateSportsPath = `/artifacts/${appId}/users/${uid}/userDefinedSports/sportsDoc`;
                const docRef = doc(db, privateSportsPath);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data().sports : {};
            }

            /**
             * Speichert benutzerdefinierte Sportarten in Firestore.
             * @param {object} sports - Das Objekt mit Sportarten und Gewichtungen.
             */
            async function saveUserDefinedSports(sports) {
                if (!db) return;
                try {
                    const privateSportsPath = `/artifacts/${appId}/users/${userId}/userDefinedSports/sportsDoc`;
                    await setDoc(doc(db, privateSportsPath), { sports });
                } catch (e) {
                    console.error("Fehler beim Speichern der Sportarten: ", e);
                }
            }

            /**
             * Ruft die Leaderboard-Daten aus Firestore ab.
             */
            async function getLeaderboard() {
                if (!db) {
                    console.error("Firestore-Instanz ist nicht verfügbar.");
                    return [];
                }
                const publicLeaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                const q = query(collection(db, publicLeaderboardPath));
                const querySnapshot = await getDocs(q);
                const participants = [];
                querySnapshot.forEach(doc => {
                    participants.push({ id: doc.id, ...doc.data() });
                });
                return participants;
            }

            /**
             * Aktualisiert die Statistiken eines Benutzers im öffentlichen Leaderboard.
             * @param {string} uid - Die Benutzer-ID.
             * @param {string} nickname - Der Spitzname des Benutzers.
             */
            async function updateLeaderboardStats(uid, nickname) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${uid}/sportEntries`;
                    const q = query(collection(db, privateEntriesPath));
                    const querySnapshot = await getDocs(q);

                    let totalMinutes = 0;
                    let totalWeightedMinutes = 0;
                    const sportsData = allSports;

                    querySnapshot.forEach(doc => {
                        const entry = doc.data();
                        const weight = sportsData[entry.sport] || 1.0;
                        totalMinutes += entry.minutes;
                        totalWeightedMinutes += entry.minutes * weight;
                    });

                    const publicDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, uid);
                    await setDoc(publicDocRef, {
                        nickname: nickname,
                        minutes: totalMinutes,
                        weightedMinutes: totalWeightedMinutes,
                        lastUpdated: new Date()
                    }, { merge: true });

                } catch (e) {
                    console.error("Fehler beim Aktualisieren des Leaderboards:", e);
                }
            }
            
            /** Lädt alle notwendigen Daten aus der DB und aktualisiert die UI */
            async function loadAllData() {
                try {
                    appContainer.innerHTML = `<p class="text-center text-slate-400">Lade App-Daten...</p>`;
                    entries = await getSportEntries(userId);
                    allSports = { ...SPORT_WEIGHTS, ...(await getUserDefinedSports(userId)) };
                    leaderboardParticipants = await getLeaderboard();
                    
                    renderApp();
                } catch (error) {
                    console.error("Fehler beim Laden der App-Daten: ", error);
                    showDynamicModal("Fehler", "Daten konnten nicht geladen werden. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            /**
             * Holt alle Daten vom alten Profil und speichert sie unter der neuen userId.
             */
            async function importProfileData(oldUserId, newNickname) {
                if (!db || !userId) return showToast("Fehler: Datenbank nicht bereit.", "error");

                try {
                    // 1. Lade Einträge und Sportarten des alten Benutzers
                    showToast("Lade alte Profildaten...", "info");
                    const oldEntries = await getSportEntries(oldUserId);
                    const oldSports = await getUserDefinedSports(oldUserId);
                    
                    // 2. Leaderboard des neuen UIDs aktualisieren
                    const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                    await setDoc(doc(db, leaderboardPath, userId), { nickname: newNickname, minutes: 0, weightedMinutes: 0 }, { merge: true });
                    
                    // 3. Füge die Sportarten zum neuen UID hinzu
                    await saveUserDefinedSports(oldSports); 
                    
                    // 4. Füge alle alten Einträge dem neuen UID hinzu
                    showToast("Migriere Einträge...", "info");
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    const batchPromises = oldEntries.map(entry => {
                        const firestoreEntry = {
                            ...entry,
                            userId: userId,
                            nickname: newNickname,
                            timestamp: entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp)
                        };
                        return addDoc(collection(db, privateEntriesPath), firestoreEntry);
                    });
                    await Promise.all(batchPromises);
                    
                    // 5. Leaderboard-Statistik des neuen Benutzers aktualisieren
                    await updateLeaderboardStats(userId, newNickname);

                    showToast("Profil erfolgreich übernommen!", "success");
                    return true;
                    
                } catch (e) {
                    console.error("Fehler beim Importieren des Profils:", e);
                    showDynamicModal("Importfehler", "Beim Versuch, das Profil zu übernehmen, ist ein Fehler aufgetreten.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    return false;
                }
            }


            // =====================================
            // UI Rendering und Update Funktionen
            // =====================================

            /**
             * Zeigt ein dynamisches modales Fenster mit anpassbarem Titel, Nachricht und Buttons an.
             * @param {string} title - Der Titel des Modals.
             * @param {string} message - Die Nachricht des Modals.
             * @param {Array<Object>} buttons - Ein Array von Button-Konfigurationsobjekten.
             */
            function showDynamicModal(title, message, buttons) {
                modalContentWrapper.innerHTML = `
                    <h3 class="text-xl font-bold mb-2 ${title.includes("Fehler") || title.includes("löschen") ? 'text-secondary' : 'text-primary'}">${title}</h3>
                    <p class="text-slate-300 mb-4">${message}</p>
                    <div class="flex justify-end gap-2 mt-4" id="modal-buttons"></div>
                `;
                modal.classList.remove('hidden');

                const buttonContainer = document.getElementById('modal-buttons');
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.id = btnConfig.id;
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.class;
                    button.addEventListener('click', btnConfig.onClick);
                    buttonContainer.appendChild(button);
                });
            }
            
            /** Rendert das Anmeldeformular für den Spitznamen. */
            function renderNicknameForm() {
                // Ursprüngliche UI des Nickname-Formulars wiederherstellen, aber mit verstecktem Import-Teil
                appContainer.innerHTML = `
                    <div class="text-center p-6 bg-slate-700 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Willkommen!</h2>
                        <p class="text-slate-300 mb-4">Geben Sie Ihren Spitznamen ein, um zu beginnen.</p>
                        <form id="nickname-form" class="space-y-4">
                            <input type="text" id="nickname-input" placeholder="Ihr Spitzname" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Starten</button>
                        </form>

                        <!-- Import-Sektion für die Cross-Device Nutzung, standardmäßig ausgeblendet -->
                        <div id="import-section-toggle" class="text-center mt-4 pt-4 border-t border-slate-600">
                            <button id="show-import-btn" class="text-sm text-primary hover:text-blue-400">Ich habe bereits ein Profil (ID-Import)</button>
                        </div>
                        
                        <div id="import-section" class="hidden space-y-4 pt-4">
                            <p class="text-slate-400 text-sm">Geben Sie die **Profil-ID** (vom Leaderboard) ein, um Ihre Daten auf dieses Gerät zu übertragen.</p>
                            <input type="text" id="import-id-input" placeholder="Alte Profil-ID (z.B. 1234abc...)" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <button type="button" id="import-profile-btn" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Profil importieren & übernehmen</button>
                            <div id="import-error" class="text-secondary text-sm mt-2 hidden"></div>
                        </div>
                    </div>
                `;

                // NEUE Event-Listener für den Import-Toggle
                const importSection = document.getElementById('import-section');
                document.getElementById('show-import-btn').addEventListener('click', () => {
                    importSection.classList.remove('hidden');
                    document.getElementById('import-section-toggle').classList.add('hidden');
                });
                
                const nicknameForm = document.getElementById('nickname-form');
                const nicknameInput = document.getElementById('nickname-input');
                const importIdInput = document.getElementById('import-id-input');
                const importProfileBtn = document.getElementById('import-profile-btn');
                const importErrorEl = document.getElementById('import-error');


                // Handle NEUES PROFIL erstellen
                nicknameForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const nickname = nicknameInput.value.trim();
                    if (nickname) {
                        currentUser = nickname;
                        await setDoc(doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId), { nickname: currentUser }, { merge: true });
                        await loadAllData();
                        isAppReady = true;
                        renderApp();
                    } else {
                        showDynamicModal("Ungültiger Spitzname", "Bitte geben Sie einen gültigen Spitznamen ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    }
                });

                // Handle PROFIL IMPORTIEREN (Funktionalität beibehalten)
                document.getElementById('import-profile-btn')?.addEventListener('click', async () => {
                    const oldUserId = document.getElementById('import-id-input').value.trim();
                    const importErrorEl = document.getElementById('import-error');

                    if (oldUserId === userId) {
                        importErrorEl.textContent = 'Dies ist Ihre aktuelle Sitzungs-ID.';
                        importErrorEl.classList.remove('hidden');
                        return;
                    }

                    if (!oldUserId) {
                        importErrorEl.textContent = 'Bitte geben Sie eine gültige Profil-ID ein.';
                        importErrorEl.classList.remove('hidden');
                        return;
                    }
                    
                    importErrorEl.classList.add('hidden');

                    const oldUserDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, oldUserId);
                    const oldUserDoc = await getDoc(oldUserDocRef);
                    
                    if (!oldUserDoc.exists()) {
                        importErrorEl.textContent = 'Kein Profil mit dieser ID gefunden.';
                        importErrorEl.classList.remove('hidden');
                        return;
                    }

                    const oldNickname = oldUserDoc.data().nickname;
                    
                    // Bestätigungsmodal
                    showDynamicModal(
                        "Profil übernehmen?",
                        `Möchten Sie das Profil von **"${oldNickname}"** auf dieses Gerät übernehmen? Dadurch werden alle Aktivitätsdaten und Sportart-Definitionen dieses Profils auf Ihre aktuelle Sitzungs-ID übertragen.`,
                        [
                            { id: 'confirm-yes-import-btn', text: 'Ja, Profil übernehmen', class: 'bg-accent text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors', onClick: async () => {
                                modal.classList.add('hidden');
                                const success = await importProfileData(oldUserId, oldNickname);
                                if (success) {
                                    // Nach erfolgreichem Import muss der neue Benutzer mit den neuen Daten geladen werden
                                    currentUser = oldNickname;
                                    await loadAllData();
                                    isAppReady = true;
                                    renderApp();
                                }
                            }},
                            { id: 'confirm-no-import-btn', text: 'Abbrechen', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
                        ]
                    );
                });
            }

            // =====================================
            // Formular-Handling
            // =====================================
            async function handleFormSubmit(e) {
                e.preventDefault();
                const sportSelect = document.getElementById('sport-select');
                const dateInput = document.getElementById('date-input');
                const minutesInput = document.getElementById('minutes-input');
                const sport = sportSelect.value;
                const date = dateInput.value;
                const minutes = parseInt(minutesInput.value, 10);

                if (minutes > 0 && date && userId && currentUser) {
                    const newEntry = {
                        userId: userId,
                        nickname: currentUser,
                        sport: sport,
                        minutes: minutes,
                        timestamp: new Date(date)
                    };
                    
                    await addSportEntry(newEntry);
                    
                    minutesInput.value = '0';
                    showSection('dashboard');
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            async function handleAddSportFormSubmit(e) {
                e.preventDefault();
                const newSportNameInput = document.getElementById('new-sport-name');
                const newSportWeightInput = document.getElementById('new-sport-weight');
                const sportName = newSportNameInput.value.trim();
                const sportWeight = parseFloat(newSportWeightInput.value);

                if (sportName && !isNaN(sportWeight) && sportWeight > 0) {
                    const userSports = { ...allSports };
                    userSports[sportName] = sportWeight;
                    
                    await saveUserDefinedSports(userSports);
                    
                    showToast("Sportart hinzugefügt!", "success");
                    newSportNameInput.value = '';
                    newSportWeightInput.value = '';
                    
                    await loadAllData();
                    renderSportWeightList();
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie einen gültigen Namen und eine positive Zahl für die Gewichtung ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            // --- CRUD-Funktionen für Einträge ---
            function handleDeleteClick(docId) {
                showDynamicModal(
                    "Eintrag löschen",
                    "Möchten Sie diesen Eintrag wirklich unwiderruflich löschen?",
                    [
                        { id: 'confirm-yes-btn', text: 'Ja', class: 'bg-secondary text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors', onClick: async () => {
                            await deleteSportEntry(docId);
                            modal.classList.add('hidden');
                        }},
                        { id: 'confirm-no-btn', text: 'Nein', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
                    ]
                );
            }

            function handleEditClick(docId) {
                editingDocId = docId;
                renderRecentActivities(entries.filter(entry => entry.userId === displayedUserId));
            }

            async function handleSaveEdit(docId) {
                const editedSport = document.getElementById('edit-sport-select').value;
                const editedMinutes = parseInt(document.getElementById('edit-minutes-input').value);
                const editedDate = document.getElementById('edit-date-input').value;
                
                if (editedMinutes > 0 && editedDate) {
                    const newEntry = {
                        sport: editedSport,
                        minutes: editedMinutes,
                        timestamp: new Date(editedDate),
                    };
                    
                    await updateSportEntry(docId, newEntry);
                    
                    editingDocId = null;
                    renderDashboard();
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            function handleCancelEdit() {
                editingDocId = null;
                renderDashboard();
            }

            // =====================================
            // App-Initialisierung
            // =====================================
            async function migrateDataFromLocalStorage(firebaseUid) {
                appContainer.innerHTML = `<p class="text-center text-slate-400">Migriere lokale Daten...</p>`;
                
                const localStorageUserId = localStorage.getItem('userId');
                const localStorageNickname = localStorage.getItem('nickname');
                const sportEntriesStr = localStorage.getItem('sportEntries');
                
                if (!localStorageUserId || !localStorageNickname || !sportEntriesStr) {
                    console.warn("Lokalstorage-Daten fehlen. Migration wird übersprungen.");
                    await checkUserExistsAndLoad();
                    return;
                }

                try {
                    const entriesToMigrate = JSON.parse(sportEntriesStr).filter(entry => 
                        entry.userId === localStorageUserId && entry.nickname === localStorageNickname
                    );
                    
                    if (entriesToMigrate.length > 0) {
                        const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                        await setDoc(doc(db, leaderboardPath, firebaseUid), { nickname: localStorageNickname, migratedFrom: localStorageUserId }, { merge: true });

                        const privateEntriesPath = `/artifacts/${appId}/users/${firebaseUid}/sportEntries`;
                        const batchPromises = entriesToMigrate.map(entry => {
                            const firestoreEntry = {
                                ...entry,
                                userId: firebaseUid,
                                nickname: localStorageNickname,
                                timestamp: new Date(entry.timestamp)
                            };
                            return addDoc(collection(db, privateEntriesPath), firestoreEntry);
                        });
                        await Promise.all(batchPromises);

                        const userDefinedSportsStr = localStorage.getItem('userDefinedSports');
                        if (userDefinedSportsStr) {
                            const sports = JSON.parse(userDefinedSportsStr);
                            const privateSportsPath = `/artifacts/${appId}/users/${firebaseUid}/userDefinedSports/sportsDoc`;
                            await setDoc(doc(db, privateSportsPath), { sports });
                        }
                    
                        showToast("Lokale Daten erfolgreich migriert!", "success");
                    } else {
                         console.warn("Keine zu migrierenden Einträge für diesen Benutzer gefunden.");
                    }
                    
                    localStorage.removeItem('userId');
                    localStorage.removeItem('nickname');
                    localStorage.removeItem('sportEntries');
                    localStorage.removeItem('userDefinedSports');

                } catch (error) {
                    console.error("Fehler bei der Migration:", error);
                    showDynamicModal("Migrationsfehler", "Ein Fehler ist bei der Datenmigration aufgetreten. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
                finally {
                    await loadAllData();
                }
            }

            async function checkUserExistsAndLoad() {
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId);
                try {
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        currentUser = userDoc.data().nickname;
                        await loadAllData();
                        renderApp();
                    } else {
                        renderNicknameForm();
                    }
                } catch (error) {
                    console.error("Fehler beim Laden der Benutzerdaten:", error);
                    showDynamicModal("Fehler", "Benutzerdaten konnten nicht geladen werden. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            async function startApp() {
                if (!app) {
                    showConfigModal();
                    return;
                }

                if (!auth || !db) {
                    console.error("Firebase Auth oder Firestore Instanz nicht initialisiert.");
                    showDynamicModal("Initialisierungsfehler", "Firebase konnte nicht richtig geladen werden. Überprüfen Sie Ihre Konfiguration.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    return;
                }
                
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error('Authentifizierungsfehler:', error);
                    showDynamicModal("Authentifizierungsfehler", "Konnte mich nicht anmelden. Bitte überprüfen Sie Ihre Internetverbindung.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    return;
                }

                userId = auth.currentUser.uid;
                displayedUserId = userId;

                const hasLocalData = localStorage.getItem('userId') && localStorage.getItem('sportEntries');
                if (hasLocalData) {
                    await migrateDataFromLocalStorage(userId);
                } else {
                    await checkUserExistsAndLoad();
                }
            }

            startApp();
        })();
    </script>
</head>
<body class="p-4 sm:p-8">
    <!-- Hauptcontainer für die gesamte App -->
    <div class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl mx-auto border border-slate-700 flex-grow">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-primary mb-2">Sport Challenge 2025/26</h1>
        <p class="text-center text-slate-400 mb-6">Erreiche 8000 Minuten Sport in einem Jahr.</p>

        <!-- Container für die Anmeldemaske oder die Haupt-App -->
        <div id="app-container">
            <p class="text-center text-slate-400">Lade App-Daten...</p>
        </div>
    </div>

    <!-- Modales Overlay für Warnungen/Meldungen -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div id="modal-content-wrapper" class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700">
        </div>
    </div>

    <!-- Toast Benachrichtigungs-Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Footer Navigation -->
    <footer class="mt-8">
    </footer>
</body>
</html>

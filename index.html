<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Challenge App</title>
    <!-- Tailwind CSS CDN für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfiguration für Tailwind CSS -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // Blau
                        secondary: '#ef4444', // Rot
                        accent: '#22c55e', // Grün
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%);
            color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        .card {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1p x rgba(0, 0, 0, 0.06);
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .toast-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            color: white;
            opacity: 0;
            animation: fadeinout 4s forwards;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toast-success { background-color: #22c55e; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }
        @keyframes fadeinout {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        /* Custom style für den Soll-Marker */
        .target-marker {
            width: 3px; 
            background-color: #ef4444; /* secondary (red) */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.8);
            z-index: 10; /* Stellt sicher, dass der Marker über dem Balken ist */
            position: absolute; /* Muss relativ zum Eltern-Div sein */
            top: 0;
            bottom: 0;
            height: 100%;
        }
        /* NEU: Tooltip-Stil für die Sportarten-Liste (behalten für den Krafttraining-Counter) */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-content {
            visibility: hidden;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            /* Korrektur: Erlaube Umbruch und setze maximale Breite */
            white-space: normal;
            max-width: 250px; 
        }
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
    </style>

    <!-- Firebase JS SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        (async function() {
            // =====================================
            // Globale Variablen und UI-Elemente
            // =====================================
            const SPORT_WEIGHTS = {
                'Laufen': 1.5,
                'Schwimmen': 1.8,
                'Radfahren': 1.2,
                'Krafttraining': 1.3,
                'Yoga': 0.8,
                'Wandern': 0.9,
                'Step Aerobic': 1.6,
                'HIIT': 1.7,
                'Kayaking': 1.1,
                // Hinzugefügt
                'Schwertkampf': 1.6, 
                'Taekwondo': 1.7,
                'Andere': 1.0
            };
            const STRENGTH_SPORTS = ['Krafttraining', 'HIIT', 'Schwertkampf', 'Taekwondo', 'Yoga']; // Liste der Kraftsportarten
            
            const GOAL_MINUTES = 8000;
            const WHO_GOAL_MINUTES = 15000; // Zweites Ziel (Maximales Ziel für Skalierung)

            // Zieldaten für die Soll-Berechnung (01.09.2025 bis 01.09.2026)
            const GOAL_START_DATE = new Date('2025-09-01T00:00:00Z');
            const GOAL_END_DATE = new Date('2026-09-01T00:00:00Z');
            const TOTAL_DURATION_MS = GOAL_END_DATE.getTime() - GOAL_START_DATE.getTime();

            const appContainer = document.getElementById('app-container');
            const modal = document.getElementById('message-modal');
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const toastContainer = document.getElementById('toast-container');
            
            let userId;
            let currentUser;
            let displayedUserId;
            let myProgressView = 'minutes';
            let chartTimeframe = 'week';
            let allSports = { ...SPORT_WEIGHTS };
            let editingDocId = null;
            let isAppReady = false;

            // Speichert die aktuell geladenen Daten
            let entries = [];
            let leaderboardParticipants = [];

            // =====================================
            // Firebase Konfiguration und Initialisierung
            // =====================================
            const firebaseConfigFromStorage = localStorage.getItem('firebaseConfig');
            const firebaseConfig = firebaseConfigFromStorage 
                ? JSON.parse(firebaseConfigFromStorage) 
                : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
            
            let app = null;
            let auth = null;
            let db = null;
            
            if (firebaseConfig.projectId) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }

            /** Zeigt das Modal zur Eingabe der Firebase-Konfiguration an */
            function showConfigModal() {
                modalContentWrapper.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-primary mb-4">Firebase Konfiguration</h3>
                        <p class="text-slate-300 mb-4">Bitte geben Sie Ihre Firebase-Konfiguration als JSON ein, um fortzufahren.</p>
                        <textarea id="config-input" rows="10" class="w-full p-2 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="{
  &quot;apiKey&quot;: &quot;...&quot;,
  &quot;authDomain&quot;: &quot;...&quot;,
  &quot;projectId&quot;: &quot;...&quot;,
  &quot;storageBucket&quot;: &quot;...&quot;,
  &quot;messagingSenderId&quot;: &quot;...&quot;,
  &quot;appId&quot;: &quot;...&quot;
}"></textarea>
                        <button id="save-config-btn" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors mt-4">Speichern und neu laden</button>
                        <div id="config-error" class="text-secondary text-sm mt-2 hidden"></div>
                    </div>
                `;
                modal.classList.remove('hidden');

                document.getElementById('save-config-btn').addEventListener('click', () => {
                    const configInput = document.getElementById('config-input').value;
                    const errorEl = document.getElementById('config-error');
                    try {
                        const parsedConfig = JSON.parse(configInput);
                        localStorage.setItem('firebaseConfig', JSON.stringify(parsedConfig));
                        window.location.reload();
                    } catch (e) {
                        errorEl.textContent = 'Ungültiges JSON-Format. Bitte überprüfen Sie Ihre Eingabe.';
                        errorEl.classList.remove('hidden');
                    }
                });
            }
            
            /** Zeigt eine Toast-Benachrichtigung an */
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }

            /**
             * Kopiert Text in die Zwischenablage und zeigt eine Bestätigung an.
             * @param {string} text - Der zu kopierende Text.
             * @param {string} message - Die Bestätigungsnachricht.
             */
            function copyToClipboard(text, message) {
                const el = document.createElement('textarea');
                el.value = text;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showToast(message, 'info');
            }

            // =====================================
            // Firebase-Datenbank-Funktionen
            // =====================================

            /**
             * Ruft die Sporteinträge eines Benutzers aus Firestore ab.
             * @param {string} uid - Die Benutzer-ID.
             */
            async function getSportEntries(uid) {
                if (!db) {
                    console.error("Firestore-Instanz ist nicht verfügbar.");
                    return [];
                }
                const privateEntriesPath = `/artifacts/${appId}/users/${uid}/sportEntries`;
                const q = query(collection(db, privateEntriesPath));
                const querySnapshot = await getDocs(q);
                const entries = [];
                querySnapshot.forEach(doc => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                return entries;
            }

            /**
             * Fügt einen neuen Sporteintrag in Firestore hinzu.
             * @param {object} entry - Das hinzuzufügende Datenobjekt.
             */
            async function addSportEntry(entry) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    await addDoc(collection(db, privateEntriesPath), entry);
                    await updateLeaderboardStats(userId, currentUser);
                    showToast("Sporteintrag hinzugefügt!", "success");
                    await loadAllData();
                } catch (e) {
                    console.error("Fehler beim Hinzufügen des Dokuments: ", e);
                    showToast("Fehler beim Hinzufügen des Eintrags.", "error");
                }
            }

            /**
             * Löscht einen Sporteintrag aus Firestore.
             * @param {string} docId - Die ID des zu löschenden Dokuments.
             */
            async function deleteSportEntry(docId) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    await deleteDoc(doc(db, privateEntriesPath, docId));
                    await updateLeaderboardStats(userId, currentUser);
                    showToast("Eintrag gelöscht.", "info");
                    await loadAllData();
                } catch (e) {
                    console.error("Fehler beim Löschen des Dokuments: ", e);
                    showToast("Fehler beim Löschen des Eintrags.", "error");
                }
            }
            
            /**
             * Aktualisiert einen bestehenden Sporteintrag in Firestore.
             * @param {string} docId - Die ID des zu aktualisierenden Dokuments.
             * @param {object} newEntry - Die aktualisierten Daten.
             */
            async function updateSportEntry(docId, newEntry) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${userId}/sportEntries`;
                    await updateDoc(doc(db, privateEntriesPath, docId), newEntry);
                    await updateLeaderboardStats(userId, currentUser);
                    showToast("Eintrag aktualisiert.", "success");
                    await loadAllData();
                } catch (e) {
                    console.error("Fehler beim Aktualisieren des Dokuments: ", e);
                    showToast("Fehler beim Aktualisieren des Eintrags.", "error");
                }
            }

            /**
             * Ruft benutzerdefinierte Sportarten aus Firestore ab.
             * @param {string} uid - Die Benutzer-ID.
             */
            async function getUserDefinedSports(uid) {
                if (!db) {
                    console.error("Firestore-Instanz ist nicht verfügbar.");
                    return {};
                }
                const privateSportsPath = `/artifacts/${appId}/users/${uid}/userDefinedSports/sportsDoc`;
                const docRef = doc(db, privateSportsPath);
                const docSnap = await getDoc(docRef);
                // Gibt nur die benutzerdefinierten Sportarten zurück (ohne Standard-Sportarten)
                return docSnap.exists() ? docSnap.data().sports : {};
            }

            /**
             * Speichert benutzerdefinierte Sportarten in Firestore.
             * @param {object} sports - Das Objekt mit Sportarten und Gewichtungen (NUR benutzerdefinierte).
             */
            async function saveUserDefinedSports(sports) {
                if (!db) return;
                try {
                    const privateSportsPath = `/artifacts/${appId}/users/${userId}/userDefinedSports/sportsDoc`;
                    // Speichert nur die benutzerdefinierten Sportarten
                    await setDoc(doc(db, privateSportsPath), { sports });
                    // allSports neu laden
                    allSports = { ...SPORT_WEIGHTS, ...sports };
                } catch (e) {
                    console.error("Fehler beim Speichern der Sportarten: ", e);
                    showToast("Fehler beim Speichern der Sportarten.", "error");
                }
            }

            /**
             * Ruft die Leaderboard-Daten aus Firestore ab.
             */
            async function getLeaderboard() {
                if (!db) {
                    console.error("Firestore-Instanz ist nicht verfügbar.");
                    return [];
                }
                const publicLeaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                const q = query(collection(db, publicLeaderboardPath));
                const querySnapshot = await getDocs(q);
                const participants = [];
                querySnapshot.forEach(doc => {
                    participants.push({ id: doc.id, ...doc.data() });
                });
                return participants;
            }

            /**
             * Aktualisiert die Statistiken eines Benutzers im öffentlichen Leaderboard.
             * @param {string} uid - Die Benutzer-ID.
             * @param {string} nickname - Der Spitzname des Benutzers.
             */
            async function updateLeaderboardStats(uid, nickname) {
                if (!db) return;
                try {
                    const privateEntriesPath = `/artifacts/${appId}/users/${uid}/sportEntries`;
                    const q = query(collection(db, privateEntriesPath));
                    const querySnapshot = await getDocs(q);

                    let totalMinutes = 0;
                    let totalWeightedMinutes = 0;
                    const sportsData = allSports;

                    querySnapshot.forEach(doc => {
                        const entry = doc.data();
                        const weight = sportsData[entry.sport] || 1.0;
                        totalMinutes += entry.minutes;
                        totalWeightedMinutes += entry.minutes * weight;
                    });

                    const publicDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, uid);
                    await setDoc(publicDocRef, {
                        nickname: nickname,
                        minutes: totalMinutes,
                        weightedMinutes: totalWeightedMinutes,
                        lastUpdated: new Date()
                    }, { merge: true });

                } catch (e) {
                    console.error("Fehler beim Aktualisieren des Leaderboards:", e);
                }
            }
            
            /** Lädt alle notwendigen Daten aus der DB und aktualisiert die UI */
            async function loadAllData() {
                try {
                    appContainer.innerHTML = `<p class="text-center text-slate-400">Lade App-Daten...</p>`;
                    entries = await getSportEntries(userId);
                    // Lade benutzerdefinierte Sportarten und füge sie zu den Standard-Sportarten hinzu
                    const userSports = await getUserDefinedSports(userId);
                    allSports = { ...SPORT_WEIGHTS, ...userSports };
                    leaderboardParticipants = await getLeaderboard();
                    
                    renderApp();
                } catch (error) {
                    console.error("Fehler beim Laden der App-Daten: ", error);
                    showDynamicModal("Fehler", "Daten konnten nicht geladen werden. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }


            // =====================================
            // UI Rendering und Update Funktionen
            // =====================================

            /**
             * Zeigt ein dynamisches modales Fenster mit anpassbarem Titel, Nachricht und Buttons an.
             * @param {string} title - Der Titel des Modals.
             * @param {string} message - Die Nachricht des Modals.
             * @param {Array<Object>} buttons - Ein Array von Button-Konfigurationsobjekten.
             */
            function showDynamicModal(title, message, buttons) {
                modalContentWrapper.innerHTML = `
                    <h3 class="text-xl font-bold mb-2 ${title.includes("Fehler") || title.includes("löschen") ? 'text-secondary' : 'text-primary'}">${title}</h3>
                    <p class="text-slate-300 mb-4">${message}</p>
                    <div class="flex justify-end gap-2 mt-4" id="modal-buttons"></div>
                `;
                modal.classList.remove('hidden');

                const buttonContainer = document.getElementById('modal-buttons');
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.id = btnConfig.id;
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.class;
                    button.addEventListener('click', btnConfig.onClick);
                    buttonContainer.appendChild(button);
                });
            }
            
            /** Rendert das Anmeldeformular für den Spitznamen. */
            function renderNicknameForm() {
                appContainer.innerHTML = `
                    <div class="text-center p-6 bg-slate-700 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Willkommen!</h2>
                        <p class="text-slate-300 mb-4">Geben Sie Ihren Spitznamen ein, um zu beginnen.</p>
                        <form id="nickname-form" class="space-y-4">
                            <input type="text" id="nickname-input" placeholder="Ihr Spitzname" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Starten</button>
                        </form>
                    </div>
                `;
                const nicknameForm = document.getElementById('nickname-form');
                const nicknameInput = document.getElementById('nickname-input');
                nicknameForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const nickname = nicknameInput.value.trim();
                    if (nickname) {
                        currentUser = nickname;
                        
                        // *** KORRIGIERT: Setze Initialwerte für Leaderboard-Felder ***
                        await setDoc(doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId), { 
                            nickname: currentUser,
                            minutes: 0,
                            weightedMinutes: 0,
                            lastUpdated: new Date()
                        }, { merge: true });
                        
                        await loadAllData();
                        isAppReady = true;
                        renderApp();
                    } else {
                        showDynamicModal("Ungültiger Spitzname", "Bitte geben Sie einen gültigen Spitznamen ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    }
                });
            }

            /** Rendert die Haupt-App. */
            function renderApp() {
                // NEU: Entferne die globale Profil-Sektion, da sie nun in der App-Sektion liegt
                document.getElementById('profile-section')?.classList.add('hidden');

                appContainer.innerHTML = `
                    <div class="flex-grow w-full max-w-4xl mx-auto space-y-6">
                        <!-- Navigationsleiste -->
                        <nav class="bg-slate-700 rounded-xl p-2 flex flex-col sm:flex-row justify-start gap-2">
                            <button data-section="dashboard" class="nav-button bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Dashboard</button>
                            <button data-section="add-entry" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Sport tracken</button>
                            <button data-section="add-sport" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Neue Sportart erstellen</button>
                            <button data-section="about-app" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Über die App</button>
                        </nav>
                        <!-- Abschnitt für das Dashboard -->
                        <div id="dashboard-section" class="space-y-6">
                            
                            <!-- Teilnehmer Abschnitt (Rangliste, AN DIE SPITZE VERSCHOBEN) -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Teilnehmer</h2>
                                <div id="leaderboard" class="space-y-4">
                                    <!-- Die Rangliste wird hier geladen -->
                                </div>
                            </div>
                            
                            <!-- Fortschritt Abschnitt (8.000 Min) -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">WHO gesund aktiv</h2>
                                <div id="progress-8000-content"></div> 
                            </div>
                            
                            <!-- Fortschritt Abschnitt (15.000 Min WHO) -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">WHO fit & stark</h2>
                                <div id="progress-15000-content"></div> 
                            </div>
                            
                            <!-- Aktivität / Graph Abschnitt -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h3 class="text-lg font-bold text-white mb-2">Aktivität (Ungewichtete Minuten)</h3>
                                <div class="flex justify-center gap-2 mb-4">
                                    <button data-timeframe="week" class="timeframe-btn bg-primary text-white font-semibold py-1 px-3 rounded-full hover:bg-blue-700 transition-colors">Woche</button>
                                    <button data-timeframe="month" class="timeframe-btn bg-slate-600 text-white font-semibold py-1 px-3 rounded-full hover:bg-slate-500 transition-colors">Monat</button>
                                    <button data-timeframe="year" class="timeframe-btn bg-slate-600 text-white font-semibold py-1 px-3 rounded-full hover:bg-slate-500 transition-colors">Jahr</button>
                                </div>
                                <canvas id="weekly-chart" class="w-full h-48"></canvas>
                            </div>

                            <!-- Minuten pro Sportart Auswertung -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Minuten pro Sportart</h2>
                                <div id="sport-summary-list" class="space-y-2">
                                    <!-- Der Inhalt wird hier geladen -->
                                </div>
                            </div>
                            <!-- Letzte Aktivitäten Abschnitt -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Letzte Aktivitäten</h2>
                                <div id="recent-activities" class="space-y-4">
                                    <!-- Die Aktivitäten werden hier geladen -->
                                </div>
                            </div>
                            
                             <!-- Personal Coach Abschnitt (NEU & EIGENSTÄNDIG) -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4 flex justify-between items-center">
                                    Dein Personal Coach 
                                    <span class="text-xs text-primary bg-slate-800 px-2 py-1 rounded-full font-semibold">Beta</span>
                                </h2>
                                <div id="personal-coach-advice" class="space-y-3">
                                    <!-- Beratung wird hier gerendert -->
                                </div>
                            </div>
                            
                        </div>
                        <!-- Abschnitt zum Eintragen von Sport -->
                        <div id="add-entry-section" class="hidden">
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Sport hinzufügen</h2>
                                <form id="add-entry-form" class="space-y-4">
                                    <div>
                                        <label for="sport-select" class="block text-slate-300 font-semibold mb-1">Sportart</label>
                                        <select id="sport-select" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                            <!-- Sportarten werden hier dynamisch geladen -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="date-input" class="block text-slate-300 font-semibold mb-1">Datum</label>
                                        <input type="date" id="date-input" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <div>
                                        <label for="minutes-input" class="block text-slate-300 font-semibold mb-1">Minuten</label>
                                        <input type="number" id="minutes-input" value="0" min="0" class="w-full p-3 rounded-lg bg-slate-800 text-white text-center text-lg font-bold border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <div class="mt-2 grid grid-cols-4 gap-2">
                                            <button type="button" data-minutes="5" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+5</button>
                                            <button type="button" data-minutes="10" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+10</button>
                                            <button type="button" data-minutes="15" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+15</button>
                                            <button type="button" data-minutes="30" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+30</button>
                                            <button type="button" data-minutes="45" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+45</button>
                                            <button type="button" data-minutes="60" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+60</button>
                                            <button type="button" id="clear-minutes-btn" class="w-full col-span-2 bg-secondary text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition-colors">Löschen</button>
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Eintrag hinzufügen</button>
                                </form>
                            </div>
                        </div>
                        <!-- Abschnitt zum Hinzufügen eigener Sportarten -->
                        <div id="add-sport-section" class="hidden">
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Eigene Sportart hinzufügen</h2>
                                <form id="add-sport-form" class="space-y-4">
                                    <div>
                                        <label for="new-sport-name" class="block text-slate-300 font-semibold mb-1">Name der Sportart</label>
                                        <input type="text" id="new-sport-name" placeholder="z.b. Boxen" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <div>
                                        <label for="new-sport-weight" class="block text-slate-300 font-semibold mb-1">Gewichtung (z.b. 1.5)</label>
                                        <input type="number" step="0.1" id="new-sport-weight" placeholder="z.b. 1.5" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Sportart hinzufügen</button>
                                </form>
                                <div class="mt-8">
                                    <h3 class="text-lg font-bold text-white mb-2">Aktuelle Sportarten und Gewichtungen</h3>
                                    <div id="sport-weight-list" class="space-y-2">
                                        <!-- Die Liste wird hier geladen -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NEUE Sektion für "Über die App" / Profil -->
                        <div id="about-app-section" class="hidden">
                            <div class="card bg-slate-700 p-6 rounded-xl border border-slate-600">
                                
                                <!-- Über die App Sektion -->
                                <section class="mb-8">
                                    <h2 class="text-2xl font-bold text-primary mb-4">Über die App</h2>
                                    <div class="space-y-4 text-slate-300">
                                        <p>Hey! Diese App ist dein persönlicher Motivator für die Sport Challenge 2025/26. Dein Ziel: Halte deinen sportlichen Fortschritt fest, messe dich mit Freunden und erreiche die Gesundheitsziele der WHO.</p>

                                        <h3 class="text-xl font-bold text-white mt-4 mb-2">Deine Ziele & die WHO-Empfehlungen</h3>
                                        <ul class="list-disc list-inside space-y-1 ml-4">
                                            <li><span class="font-semibold">WHO gesund aktiv:</span> Das Basis-Ziel. Es entspricht der minimal empfohlenen aeroben Aktivität pro Woche, auf ein Jahr hochgerechnet (8.000 Min).</li>
                                            <li><span class="font-semibold">WHO fit & stark:</span> Das Herausforderungs-Ziel für maximale Gesundheitswirkung (15.000 Min).</li>
                                            <li><span class="font-semibold">Krafttraining:</span> Die WHO empfiehlt mindestens zweimal pro Woche muskelkräftigende Übungen. Der Counter im Dashboard hilft dir, diesen wöchentlichen Rhythmus zu verfolgen.</li>
                                        </ul>
                                        
                                        <h3 class="text-xl font-bold text-white mt-4 mb-2">Warum die Gewichtungen (x-Faktor)?</h3>
                                        <p>Nicht jede Minute ist gleich! Die Gewichtungsfaktoren (z.B. Laufen x1.5) spiegeln die geschätzte Intensität wider. Aktivitäten mit höherer Intensität (z.B. Schwimmen oder HIIT) lassen deine gewichteten Minuten schneller wachsen:</p>
                                        <ul class="list-disc list-inside space-y-1 ml-4">
                                            <li>Faktoren > 1.0: Höhere Intensität (z.B. Laufen, Schwimmen).</li>
                                            <li>Faktoren < 1.0: Geringere Intensität (z.b. Yoga, Wandern).</li>
                                        </ul>
                                        <p class="text-sm text-slate-400 mt-2">Deine Ranglistenposition zählt immer nur die ungewichteten, realen Minuten, um den Vergleich fair zu halten. Die Gewichtung ist für deine persönliche Motivation da.</p>
                                    </div>
                                </section>
                                    
                                <!-- Dein Profil Sektion -->
                                <section class="p-6 rounded-xl bg-slate-800 border border-primary">
                                    <h2 class="text-2xl font-bold text-white mb-3">Dein Profil</h2>
                                    <h3 class="text-xl font-bold text-white mb-2 sm:mb-0">Spitzname: <span class="text-primary" id="profile-nickname-section"></span></h3>
                                    
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-4">
                                        <p class="text-sm text-slate-400 mb-3 sm:mb-0">
                                            Deine volle ID (zum Synchronisieren): 
                                            <code id="profile-user-id-section" class="text-xs text-accent select-all font-mono"></code>
                                        </p>
                                        <button id="copy-user-id-btn-section" class="bg-primary text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                <path d="M7 3.75A2.75 2.75 0 019.75 1h5.5A2.75 2.75 0 0118 3.75v8.5A2.75 2.75 0 0115.25 15h-5.5A2.75 2.75 0 017 12.25v-8.5z" />
                                                <path fill-rule="evenodd" d="M11.375 16.5a1.25 1.25 0 01-1.25-1.25V5.25h1.5v10a.25.25 0 00.25.25h10.25a1.25 1.25 0 01-1.25 1.25h-9.5z" clip-rule="evenodd" />
                                            </svg>
                                            <span>ID kopieren</span>
                                        </button>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-3">
                                        <strong>Synchronisation:</strong> Kopiere diese ID. Auf einem <strong>neuen Gerät</strong> kannst du dich dann mit dieser ID statt mit einem neuen Spitznamen anmelden, um deinen bestehenden Account und alle deine Daten nahtlos weiterzuführen.
                                    </p>
                                </section>
                            </div>
                        </div>
                    </div>
                `;
                const dateInput = document.getElementById('date-input');
                const today = new Date().toISOString().split('T')[0];
                if (dateInput) dateInput.value = today;

                // --- LOGIK FÜR PROFIL-SEKTION (INNERHALB DER APP) ---
                const profileNicknameEl = document.getElementById('profile-nickname-section');
                const profileUserIdEl = document.getElementById('profile-user-id-section');
                const copyIdBtn = document.getElementById('copy-user-id-btn-section');

                if (profileNicknameEl && profileUserIdEl && userId && currentUser) {
                    profileNicknameEl.textContent = currentUser;
                    profileUserIdEl.textContent = userId;
                    
                    if (copyIdBtn) {
                         copyIdBtn.addEventListener('click', () => {
                            copyToClipboard(userId, 'Volle ID wurde in die Zwischenablage kopiert. Nutze diese, um dich auf einem anderen Gerät anzumelden.');
                        });
                    }
                }
                // --- ENDE PROFIL-LOGIK ---

                setupEventListeners();
                // Beim Start wird das Dashboard gerendert und damit die Initialdaten geladen
                showSection('dashboard');
            }

            /**
             * Zeigt einen bestimmten Abschnitt an und verbirgt die anderen.
             * @param {string} sectionId - Die ID des anzuzeigenden Abschnitts.
             */
            function showSection(sectionId) {
                document.querySelectorAll('.nav-button').forEach(btn => {
                    const isSelected = btn.dataset.section === sectionId;
                    btn.classList.toggle('bg-primary', isSelected);
                    btn.classList.toggle('hover:bg-blue-700', isSelected);
                    btn.classList.toggle('bg-slate-600', !isSelected);
                    btn.classList.toggle('hover:bg-slate-500', !isSelected);
                });

                document.getElementById('dashboard-section').classList.toggle('hidden', sectionId !== 'dashboard');
                document.getElementById('add-entry-section').classList.toggle('hidden', sectionId !== 'add-entry');
                document.getElementById('add-sport-section').classList.toggle('hidden', sectionId !== 'add-sport');
                document.getElementById('about-app-section').classList.toggle('hidden', sectionId !== 'about-app');

                // Ruft nur die relevanten Rendering-Funktionen auf
                if (sectionId === 'dashboard') {
                    renderDashboardContent();
                    renderSportSelect();
                } else if (sectionId === 'add-sport') {
                    renderSportSelect(); // Für das Dropdown im Hinzufügen-Formular
                    renderAddSportSectionContent(); // Rendert die Liste der Sportarten
                } else if (sectionId === 'add-entry') {
                    renderSportSelect(); // Für das Dropdown im Eintragsformular
                }
            }

            /** Aktualisiert die UI-Elemente, die sich im Dashboard befinden */
            function renderDashboardContent() {
                const currentEntries = entries.filter(entry => entry.userId === displayedUserId);
                renderLeaderboard(leaderboardParticipants); // An die Spitze verschoben
                renderGoalProgress('8000', GOAL_MINUTES, currentEntries);
                renderGoalProgress('15000', WHO_GOAL_MINUTES, currentEntries); 
                renderSportSummary(currentEntries);
                renderRecentActivities(currentEntries);
                renderPersonalCoach(currentEntries); // NEU: Personal Coach rendern
            }

            /** Aktualisiert die UI-Elemente, die sich in der Sporterstell-Sektion befinden */
            function renderAddSportSectionContent() {
                renderSportWeightList();
            }
            
            // =====================================
            // Personal Coach Modul
            // =====================================

            /** Berechnet den Fortschritt beim Krafttraining über den gesamten Zeitraum. */
            function calculateStrengthTrainingProgress(entries) {
                const now = new Date();
                const startDate = GOAL_START_DATE;
                const requiredWeeklyRate = 2; // WHO requirement
                
                // 1. Calculate Actual Strength Days achieved in the challenge window
                const strengthDaysAchieved = new Set();
                entries.forEach(entry => {
                    const entryDate = entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);
                    // Ensure entry is within the overall challenge period and is a strength sport
                    if (STRENGTH_SPORTS.includes(entry.sport) && entryDate >= startDate && entryDate <= now) {
                        // Count unique days (date part only)
                        strengthDaysAchieved.add(entryDate.toISOString().split('T')[0]);
                    }
                });

                const actualDays = strengthDaysAchieved.size;

                // 2. Calculate Required Strength Days (Soll)
                const elapsedMs = now.getTime() - startDate.getTime();
                
                let requiredDays = 0;
                
                if (elapsedMs > 0 && TOTAL_DURATION_MS > 0) {
                    // Days elapsed since start (clamped at total duration to avoid future calculation)
                    const elapsedDays = Math.min(elapsedMs / (1000 * 60 * 60 * 24), TOTAL_DURATION_MS / (1000 * 60 * 60 * 24));
                    
                    // Required strength days = (Elapsed Days / 7 days) * 2 days
                    requiredDays = (elapsedDays / 7) * requiredWeeklyRate;
                } else if (elapsedMs >= TOTAL_DURATION_MS) {
                    // If challenge is over, goal is the total maximum days (52 weeks * 2 days)
                    requiredDays = (TOTAL_DURATION_MS / (1000 * 60 * 60 * 24) / 7) * requiredWeeklyRate; 
                }
                
                return { actualDays: actualDays, requiredDays: requiredDays };
            }
            
            /** Rendert den Personal Coach Abschnitt */
            function renderPersonalCoach(myEntries) {
                const coachEl = document.getElementById('personal-coach-advice');
                if (!coachEl) return;

                const { requiredProgressPercentage: required8k, requiredMinutes: required8kMin } = calculateRequiredProgress(GOAL_MINUTES);
                const { requiredProgressPercentage: required15k, requiredMinutes: required15kMin } = calculateRequiredProgress(WHO_GOAL_MINUTES);
                
                const totalMinutes = myEntries.reduce((sum, entry) => sum + entry.minutes, 0);
                
                const progress8k = (totalMinutes / GOAL_MINUTES) * 100;
                const progress15k = (totalMinutes / WHO_GOAL_MINUTES) * 100;
                
                const minutesLag8k = required8k - progress8k;
                const minutesLag15k = required15k - progress15k;

                const { actualDays, requiredDays } = calculateStrengthTrainingProgress(myEntries);
                const strengthLag = requiredDays - actualDays;
                
                let adviceHeadline = "Phänomenal! Du bist voll im Flow.";
                let adviceColor = "text-accent"; // Grün
                
                let adviceTextHtml = ''; // Wird für Absätze und formatierte Texte verwendet
                
                let maxLag = 0; // Größter Rückstand in Prozent (für Minuten) oder Tagen (für Kraft)
                
                // Priorität der Analyse: 1. Krafttraining, 2. 8k-Minuten, 3. 15k-Minuten
                if (strengthLag > 10) { 
                    maxLag = strengthLag;
                } else if (minutesLag8k > 5) {
                    maxLag = minutesLag8k;
                } else if (minutesLag15k > 5 && GOAL_MINUTES > required8kMin) {
                     maxLag = minutesLag15k;
                }

                // --- Auswertung und spezifische Verbesserungsvorschläge ---
                if (maxLag > 0) {
                    adviceColor = "text-secondary"; // Rot
                    
                    adviceTextHtml += `<h3 class="text-lg font-bold text-white mt-1">Status-Analyse:</h3>`;

                    if (strengthLag === maxLag && strengthLag > 10) { // Fokus auf Krafttraining
                        adviceHeadline = "Hol dir deine Kraft zurück!";
                        adviceTextHtml += `<p class="text-slate-300">Du bist stark bei der Ausdauer, aber wir sehen eine Lücke im Bereich <span class="font-bold text-secondary">Krafttraining</span>. Die WHO empfiehlt 2 Einheiten pro Woche, aber du liegst um <span class="font-bold text-secondary">${strengthLag.toFixed(1)} Tage</span> hinter dem Plan (2x/Woche). Krafttraining ist essenziell für Stabilität!</p>`;
                        
                        adviceTextHtml += `<h3 class="text-lg font-bold text-primary mt-3">Deine motivierende Mission:</h3>`;
                        adviceTextHtml += `<p class="text-white">Beginne diese Woche mit <span class="font-bold">einer 15-minütigen</span> Yoga- oder Krafttrainingseinheit. Wichtig ist die Regelmäßigkeit, nicht die Härte. Du schaffst das!</p>`;
                    } else if (minutesLag8k === maxLag && minutesLag8k > 5) { // Fokus auf 8k Minuten
                        adviceHeadline = "Jetzt Gegensteuern! Dein Grundziel ruft.";
                        adviceTextHtml += `<p class="text-slate-300">Du bist ein Kämpfer, aber der Plan <span class="font-bold">WHO gesund aktiv</span> läuft dir mit <span class="font-bold text-secondary">${minutesLag8k.toFixed(1)}%</span> Vorsprung davon. Keine Sorge, das holen wir auf!</p>`;
                        
                        const topSport = Object.keys(myEntries.reduce((acc, entry) => {
                            acc[entry.sport] = (acc[entry.sport] || 0) + entry.minutes;
                            return acc;
                        }, {})).sort((a, b) => myEntries.filter(e => e.sport === b).length - myEntries.filter(e => e.sport === a).length)[0] || "Laufen";
                        
                        adviceTextHtml += `<h3 class="text-lg font-bold text-primary mt-3">Deine motivierende Mission:</h3>`;
                        adviceTextHtml += `<p class="text-white">Füge deinen nächsten <span class="font-bold">${topSport}</span>-Einheiten <span class="font-bold">jeweils 15 Minuten</span> hinzu. Kleine Steigerungen bringen große Ergebnisse!</p>`;
                    } else if (minutesLag15k === maxLag && minutesLag15k > 5) { // Fokus auf 15k Minuten
                        adviceHeadline = "Du bist fast am Gipfel! Top-Ziel in Sicht.";
                        adviceTextHtml += `<p class="text-slate-300">Du hast das 8.000-Minuten-Ziel fest im Griff! Um das anspruchsvolle Ziel <span class="font-bold text-primary">WHO fit & stark</span> zu knacken, müssen wir die Intensität leicht erhöhen. Der Rückstand beträgt <span class="font-bold text-secondary">${minutesLag15k.toFixed(1)}%</span>.</p>`;
                        adviceTextHtml += `<h3 class="text-lg font-bold text-primary mt-3">Deine motivierende Mission:</h3>`;
                        adviceTextHtml += `<p class="text-white">Wähle eine Aktivität mit hohem Multiplikator (wie Schwimmen oder HIIT) und plane eine <span class="font-bold">zweite Session</span> pro Woche ein. Wir lieben Herausforderungen!</p>`;
                    }
                } else {
                     // Status Gut: Kurze Einschätzung beider Ziele
                    adviceHeadline = "Phänomenal! Du bist voll im Flow.";
                    adviceTextHtml += `<h3 class="text-lg font-bold text-white mt-1">Status-Analyse:</h3>`;
                    adviceTextHtml += `<p class="text-slate-300">Herzlichen Glückwunsch! Du liegst bei beiden Minutenzielen (<span class="font-bold">8.000 Min & 15.000 Min</span>) <span class="font-bold text-accent">im Zeitplan</span> und erfüllst die Krafttrainings-Empfehlung. Dein Engagement ist beeindruckend!</p>`;
                    
                    adviceTextHtml += `<h3 class="text-lg font-bold text-primary mt-3">Dein nächster Fokus:</h3>`;
                    adviceTextHtml += `<p class="text-white">Halte diesen Rhythmus bei und beginne, das 15.000-Minuten-Ziel als deine neue Basis zu sehen. Der Schlüssel ist jetzt Konsistenz und Freude an der Bewegung.</p>`;
                }
                
                // --- Langfristiger Nutzen ---
                adviceTextHtml += `
                    <div class="mt-6 pt-4 border-t border-slate-600">
                        <h3 class="text-lg font-bold text-accent mb-2">Dein langfristiger Gewinn:</h3>
                        <p class="text-slate-400 text-sm">
                            Jeder Schritt, den du machst, ist eine Investition in dich selbst. Durch dieses Engagement stärkst du nicht nur deine Muskeln und Ausdauer, sondern verbesserst aktiv deine <span class="font-bold">Herzgesundheit</span>, steigerst dein <span class="font-bold">Energielevel</span> und sicherst dir einen <span class="font-bold">erholsameren Schlaf</span>. Diese Gewohnheit ist dein größter Erfolg – sie hält dich weit über diese Challenge hinaus fit und energiegeladen! 
                        </p>
                    </div>
                `;

                // --- Ausgabe rendern ---
                coachEl.innerHTML = `
                    <div class="flex items-center space-x-3 pb-2">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 ${adviceColor}">
                            <path fill-rule="evenodd" d="M18.685 19.02a1.75 1.75 0 00.32-1.077c-.125-.975-.382-1.89-.752-2.733.917-.79 1.543-1.815 1.713-2.913a.75.75 0 10-1.472-.379c-.1.385-.292.775-.55 1.082a.75.75 0 00-.094.137c-.77 1.016-1.58 2.05-2.098 3.197.802.43 1.34 1.155 1.5 2.055a.75.75 0 001.446-.247zM20 12.375a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v1.5a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75v-1.5zM12.375 20a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v1.5a.75.75 0 00.75.75h1.5zM11.25 4.5c.32 0 .584-.236.654-.537l.006-.027a1.5 1.5 0 00-1.82 1.488c0 .247.165.45.39.45h.77zM4.5 11.25c0 .723.364 1.378.932 1.753l.053-.028a.75.75 0 00.767-1.375c-.27-.151-.45-.44-.45-.75v-.77c.32 0 .584-.236.654-.537l.006-.027a1.5 1.5 0 00-1.82 1.488c0 .247.165.45.39.45h-.77zM12 4.5c.32 0 .584-.236.654-.537l.006-.027a1.5 1.5 0 00-1.82 1.488c0 .247.165.45.39.45h.77zM4.5 11.25c0 .723.364 1.378.932 1.753l.053-.028a.75.75 0 00.767-1.375c-.27-.151-.45-.44-.45-.75v-.77c.32 0 .584-.236.654-.537l.006-.027a1.5 1.5 0 00-1.82 1.488c0 .247.165.45.39.45h-.77zM12 4.5c.32 0 .584-.236.654-.537l.006-.027a1.5 1.5 0 00-1.82 1.488c0 .247.165.45.39.45h.77zM4.5 11.25c0 .723.364 1.378.932 1.753l.053-.028a.75.75 0 00.767-1.375c-.27-.151-.45-.44-.45-.75v-.77c.32 0 .584-.236.654-.537l.006-.027a1.5 1.5 0 00-1.82 1.488c0 .247.165.45.39.45h-.77z" clip-rule="evenodd" />
                        </svg>
                        <h3 class="text-xl font-bold ${adviceColor}">${adviceHeadline}</h3>
                    </div>
                    ${adviceTextHtml}
                `;
            }
            // =====================================
            // Ende Personal Coach Modul
            // =====================================
            

            /** Kürzt die Firebase UID für die Anzeige. */
            function formatUserId(uid) {
                if (!uid) return 'N/A';
                return uid.substring(0, 8); // Zeigt die ersten 8 Zeichen der UID
            }

            /** Hilfsfunktion zur Berechnung des Soll-Fortschritts für die Minuten. */
            function calculateRequiredProgress(goalMinutes) {
                const now = new Date();
                const elapsedTimeMs = now.getTime() - GOAL_START_DATE.getTime();
                
                let requiredProgressPercentage = 0;
                let requiredMinutes = 0;

                if (elapsedTimeMs > 0 && TOTAL_DURATION_MS > 0) {
                    const clampedElapsedTimeMs = Math.min(elapsedTimeMs, TOTAL_DURATION_MS); 
                    requiredProgressPercentage = (clampedElapsedTimeMs / TOTAL_DURATION_MS) * 100;
                    requiredMinutes = (requiredProgressPercentage / 100) * goalMinutes;
                } else if (elapsedTimeMs >= TOTAL_DURATION_MS) {
                    requiredProgressPercentage = 100;
                    requiredMinutes = goalMinutes;
                }
                return { requiredProgressPercentage, requiredMinutes };
            }

            /** Rendert die Sportarten-Dropdown-Liste neu */
            function renderSportSelect() {
                const sportSelect = document.getElementById('sport-select');
                // Hinzugefügt für das Bearbeitungs-Dropdown, das nach dem DOM-Update möglicherweise noch existiert
                const editSportSelect = document.getElementById('edit-sport-select'); 

                const optionsHtml = Object.keys(allSports).map(sport => 
                    `<option value="${sport}">${sport} (x${allSports[sport]})</option>`
                ).join('');
                
                if (sportSelect) sportSelect.innerHTML = optionsHtml;
                // Aktualisiere auch das Bearbeitungs-Dropdown, falls es im DOM ist
                if (editSportSelect) {
                    const currentEntry = entries.find(e => e.id === editingDocId);
                    if (currentEntry) {
                        editSportSelect.innerHTML = Object.keys(allSports).map(sport => 
                            `<option value="${sport}" ${sport === currentEntry.sport ? 'selected' : ''}>${sport} (x${allSports[sport]})</option>`
                        ).join('');
                    } else {
                        editSportSelect.innerHTML = optionsHtml;
                    }
                }
            }
            
            /** Rendert die Liste der Sportarten und ihrer Gewichtungen. */
            function renderSportWeightList() {
                const sportWeightListEl = document.getElementById('sport-weight-list');
                if (!sportWeightListEl) return;
                
                sportWeightListEl.innerHTML = Object.entries(allSports).map(([sport, weight]) => {
                    // Prüfe, ob es sich um eine benutzerdefinierte Sportart handelt (Nicht in den Standard-Weights)
                    const isCustom = !SPORT_WEIGHTS.hasOwnProperty(sport); 
                    
                    const deleteButton = isCustom ? `
                        <button data-sport-name="${sport}" data-action="delete-sport" class="text-secondary hover:text-red-400 transition-colors text-sm font-semibold p-1 rounded-lg">
                            Löschen
                        </button>
                    ` : `<span class="text-slate-500 text-sm">Standard</span>`;

                    return `
                        <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600 ${isCustom ? 'border-primary' : ''}">
                            <span class="text-white font-semibold">${sport}</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-primary font-bold">x${weight}</span>
                                ${deleteButton}
                            </div>
                        </div>
                    `;
                }).join('');

                 // Event-Delegation für den Lösch-Button
                sportWeightListEl.querySelectorAll('[data-action="delete-sport"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const sportName = e.target.dataset.sportName;
                        handleDeleteSport(sportName);
                    });
                });
            }

            /** NEUE VEREINFACHTE FUNKTION: Rendert einen Fortschrittsbalken. */
            function renderGoalProgress(idSuffix, goalMinutes, myEntries) {
                const containerEl = document.getElementById(`progress-${idSuffix}-content`);
                if (!containerEl || !myEntries) return;

                const isWeighted = idSuffix === '8000'; // Nur das 8000er Ziel hat Umschalt-Option und gewichtete Minuten
                const currentView = isWeighted ? myProgressView : 'minutes';
                
                const { requiredProgressPercentage, requiredMinutes } = calculateRequiredProgress(goalMinutes);
                
                // --- BERECHNUNG: Ist-Fortschritt ---
                const totalMinutes = myEntries.reduce((sum, entry) => sum + entry.minutes, 0);
                const totalWeightedMinutes = myEntries.reduce((sum, entry) => {
                    const weight = allSports[entry.sport] || 1.0;
                    return sum + (entry.minutes * weight);
                }, 0);

                let displayValue = (currentView === 'minutes') ? totalMinutes : totalWeightedMinutes;
                let progress = (displayValue / goalMinutes) * 100;
                let isGoalReached = progress >= 100;
                
                // *** SKALIERUNG FÜR PROPORTIONALITÄT ***
                const maxGoal = WHO_GOAL_MINUTES;
                const relativeWidth = (goalMinutes / maxGoal) * 100;

                // --- HTML-STRUKTUR & METRIKEN ---
                let metricBoxes = `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4 text-center">
                        <div class="p-3 rounded-lg bg-slate-800 border border-slate-600">
                            <div class="text-xs text-slate-400">Erreicht (Ist)</div>
                            <div class="text-xl font-bold ${isGoalReached ? 'text-primary' : 'text-white'}">${displayValue.toFixed(currentView === 'weighted' ? 1 : 0)} Min</div>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-800 border border-slate-600">
                            <div class="text-xs text-slate-400">Soll (${requiredProgressPercentage.toFixed(1)}%)</div>
                            <div class="text-xl font-bold text-secondary">${requiredMinutes.toFixed(0)} Min</div>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-800 border border-slate-600">
                            <div class="text-xs text-slate-400">Status</div>
                            <div class="text-xl font-bold ${isGoalReached ? 'text-accent' : (progress >= requiredProgressPercentage ? 'text-primary' : 'text-secondary')}">
                                ${isGoalReached ? 'Ziel erreicht!' : (progress >= requiredProgressPercentage ? 'Im Zeitplan' : 'Aufholen nötig')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Umschalt-Button nur für das 8000er Ziel
                const toggleButton = isWeighted ? `
                    <div class="flex justify-center mb-4 items-center space-x-3">
                        <button id="toggle-progress-btn" data-goal-id="${idSuffix}" class="text-sm text-white py-1 px-3 rounded-full bg-primary hover:bg-blue-700 transition-colors">
                            Ansicht: ${currentView === 'minutes' ? 'Zu Gewichtete Min. wechseln' : 'Zu Ungewichtete Min. wechseln'}
                        </button>
                    </div>
                ` : `<div class="mb-4"></div>`; // Platzhalter für Konsistenz

                // --- KRAFTTRAINING COUNTER (NUR BEI 15000er ZIEL) ---
                let strengthCounter = '';
                if (idSuffix === '15000') {
                    const { actualDays, requiredDays } = calculateStrengthTrainingProgress(myEntries);
                    const isGoalMet = actualDays >= requiredDays;
                    const strengthTooltipContent = `Eingerechnete Sportarten: ${STRENGTH_SPORTS.join(', ')}`;
                    
                    strengthCounter = `
                        <div class="mt-6 p-4 rounded-xl bg-slate-800 border border-slate-600">
                            <div class="flex justify-between items-start">
                                <div class="relative tooltip-container">
                                    <h3 class="text-lg font-bold text-white mb-1 flex items-center">
                                        Krafttraining (2x/Woche)
                                        <span class="ml-2 text-primary cursor-pointer text-sm">
                                            [i]
                                            <span class="tooltip-content text-xs">${strengthTooltipContent}</span>
                                        </span>
                                    </h3>
                                </div>
                                <div class="px-3 py-1 rounded-full text-white font-semibold ${isGoalMet ? 'bg-accent' : 'bg-secondary'} text-sm">
                                    ${isGoalMet ? 'Im Zeitplan!' : 'Aufholen nötig'}
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-white text-xl font-extrabold">
                                    <span class="${isGoalMet ? 'text-accent' : 'text-secondary'}">${actualDays.toFixed(0)}</span> / ${requiredDays.toFixed(1)} Tage erreicht
                                </span>
                            </div>
                        </div>
                    `;
                }


                // --- GESAMTAUSGABE ---
                containerEl.innerHTML = `
                    ${metricBoxes}
                    ${toggleButton}
                    
                    <div style="max-width: ${relativeWidth}%;" class="w-full">
                        <div class="relative h-6 bg-slate-800 rounded-full mb-2 shadow-inner overflow-hidden">
                            <div id="progress-bar-${idSuffix}" class="h-full ${isGoalReached ? 'bg-primary' : 'bg-accent'} progress-bar-fill rounded-full" style="width: ${Math.min(100, progress)}%;"></div>
                            <div id="target-marker-${idSuffix}" class="absolute top-0 bottom-0 target-marker" title="Soll-Fortschritt" style="left: ${requiredProgressPercentage}%; transform: translateX(-50%);"></div>
                        </div>
                    </div>
                    
                    <p class="text-left text-sm font-semibold text-slate-400 mt-0">
                        Ziel: ${goalMinutes.toLocaleString('de-DE')} Minuten. Aktueller Fortschritt: ${progress.toFixed(1)}%
                    </p>

                    ${strengthCounter}
                `;
                
                // Event Listener für den Toggle-Button muss neu angehängt werden
                if (isWeighted) {
                    document.getElementById('toggle-progress-btn')?.addEventListener('click', () => {
                        myProgressView = myProgressView === 'minutes' ? 'weighted' : 'minutes';
                        renderDashboardContent();
                    });
                }

                // Stelle sicher, dass der Graph und andere Elemente aktualisiert werden
                if (idSuffix === '8000') {
                    renderWeeklyProgressGraph(myEntries);
                }
            }


            function renderWeeklyProgressGraph(myEntries) {
                const canvas = document.getElementById('weekly-chart');
                if (!canvas || !myEntries) return;

                const containerWidth = canvas.parentElement.clientWidth;
                canvas.width = containerWidth;
                canvas.height = 192;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let dataPoints = [];
                let labels = [];

                const now = new Date();
                const getEntryDate = (entry) => entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);

                if (chartTimeframe === 'week') {
                    const dailyMinutes = new Array(7).fill(0);
                    const oneWeekAgo = now.getTime() - 7 * 24 * 60 * 60 * 1000;
                    myEntries.filter(entry => getEntryDate(entry).getTime() > oneWeekAgo)
                        .forEach(entry => {
                            const entryDate = getEntryDate(entry);
                            const diffDays = Math.floor((now.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24));
                            if (diffDays >= 0 && diffDays < 7) dailyMinutes[6 - diffDays] += entry.minutes;
                        });
                    dataPoints = dailyMinutes;
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(now.getDate() - i);
                        labels.push(date.toLocaleDateString('de-DE', { weekday: 'short' }));
                    }
                } else if (chartTimeframe === 'month') {
                    const weeklyMinutes = new Array(4).fill(0);
                    const oneMonthAgo = now.getTime() - 30 * 24 * 60 * 60 * 1000;
                    myEntries.filter(entry => getEntryDate(entry).getTime() > oneMonthAgo)
                        .forEach(entry => {
                            const entryDate = getEntryDate(entry);
                            const diffDays = Math.floor((now.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24));
                            const weekIndex = Math.floor(diffDays / 7);
                            if (weekIndex >= 0 && weekIndex < 4) weeklyMinutes[3 - weekIndex] += entry.minutes;
                        });
                    dataPoints = weeklyMinutes;
                    labels = ['Woche 1', 'Woche 2', 'Woche 3', 'Woche 4'];
                } else if (chartTimeframe === 'year') {
                    const monthlyMinutes = new Array(12).fill(0);
                    const oneYearAgo = now.getTime() - 365 * 24 * 60 * 60 * 1000;
                    myEntries.filter(entry => getEntryDate(entry).getTime() > oneYearAgo)
                        .forEach(entry => {
                            const entryDate = getEntryDate(entry);
                            const diffMonths = (now.getFullYear() - entryDate.getFullYear()) * 12 + (now.getMonth() - entryDate.getMonth());
                            if (diffMonths >= 0 && diffMonths < 12) monthlyMinutes[11 - diffMonths] += entry.minutes;
                        });
                    dataPoints = monthlyMinutes;
                    for (let i = 11; i >= 0; i--) {
                        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        labels.push(monthDate.toLocaleDateString('de-DE', { month: 'short' }));
                    }
                }
                
                const maxMinutes = Math.max(...dataPoints, 1);
                const padding = 30;
                const chartHeight = canvas.height - 2 * padding;
                const chartWidth = canvas.width - 2 * padding;
                const pointSpacing = chartWidth / (dataPoints.length > 1 ? dataPoints.length - 1 : 1);

                ctx.beginPath();
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 3;
                const points = dataPoints.map((value, index) => ({
                    x: padding + index * pointSpacing,
                    y: padding + chartHeight - (value / maxMinutes) * chartHeight
                }));
                if (points.length > 0) {
                    ctx.moveTo(points[0].x, points[0].y);
                    points.forEach(point => ctx.lineTo(point.x, point.y));
                }
                ctx.stroke();
                
                ctx.textAlign = 'right';
                ctx.fillStyle = '#94a3b8';
                ctx.font = '10px Inter';
                const yLabels = [0, Math.floor(maxMinutes / 2), maxMinutes];
                yLabels.forEach(label => {
                    const y = padding + chartHeight - (label / maxMinutes) * chartHeight;
                    ctx.fillText(label, padding - 5, y + 4);
                });
                
                points.forEach(point => {
                    ctx.beginPath();
                    ctx.fillStyle = '#22c55e';
                    ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                });

                ctx.fillStyle = '#f3f4f6';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                labels.forEach((label, index) => {
                    const x = padding + index * pointSpacing;
                    ctx.fillStyle = '#94a3b8';
                    ctx.fillText(label, x, canvas.height - 5);
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillText(dataPoints[index], x, points[index].y - 10);
                });
            }

            function renderLeaderboard(participants) {
                const leaderboardEl = document.getElementById('leaderboard');
                if (!leaderboardEl || !participants) return;

                // Stelle sicher, dass minutes und weightedMinutes Zahlen sind (Fix für toFixed Fehler)
                const safeParticipants = participants.map(p => ({
                    ...p,
                    minutes: p.minutes || 0,
                    weightedMinutes: p.weightedMinutes || 0
                }));
                
                // Sortierung nach gesammelten Minuten (absteigend), unabhängig vom eingeloggten User.
                let sortedParticipants = [...safeParticipants].sort((a, b) => b.minutes - a.minutes);
                
                const minutesLeader = [...safeParticipants].sort((a, b) => b.minutes - a.minutes)[0] || { minutes: -1, id: null };
                const weightedLeader = [...safeParticipants].sort((a, b) => b.weightedMinutes - a.weightedMinutes)[0] || { weightedMinutes: -1, id: null };
                
                // KORRIGIERT: Entfernen der doppelten H2 Überschrift und beibehalten der Sortierungsbeschreibung
                leaderboardEl.innerHTML = `
                    <p class="text-sm text-slate-400 mb-4">Sortiert nach gesammelten Minuten (ungewichtet).</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        ${sortedParticipants.map((p, index) => {
                            const isMinutesLeader = p.id === minutesLeader.id;
                            const isWeightedLeader = p.id === weightedLeader.id;
                            const isActiveUser = p.id === displayedUserId;
                            
                            return `
                                <div data-user-id="${p.id}" class="flex-1 p-6 rounded-xl border-2 cursor-pointer transition-all duration-200 ease-in-out ${isActiveUser ? 'border-primary' : 'border-slate-600'} bg-slate-800 text-center relative overflow-hidden hover:scale-105">
                                    <h3 class="text-xl font-bold mb-2 text-white flex items-center justify-center">
                                        <span class="text-3xl font-extrabold mr-2 ${index === 0 ? 'text-accent' : 'text-slate-500'}">${index + 1}.</span>
                                        ${p.nickname}
                                        ${p.id === userId ? ' (Du)' : ''}
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="p-3 rounded-lg bg-slate-700">
                                            <div class="text-slate-400 text-sm">Minuten (Ungewichtet)</div>
                                            <div class="text-2xl font-extrabold ${isMinutesLeader ? 'text-primary' : 'text-white'}">
                                                ${p.minutes.toFixed(0)}
                                                ${isMinutesLeader ? '<span class="text-xs ml-1">🏆</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-slate-700">
                                            <div class="text-slate-400 text-sm">Gewichtete Min.</div>
                                            <div class="text-2xl font-extrabold ${isWeightedLeader ? 'text-accent' : 'text-white'}">
                                                ${p.weightedMinutes.toFixed(1)}
                                                ${isWeightedLeader ? '<span class="text-xs ml-1">🏆</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-sm text-slate-500 mt-2">ID: ${formatUserId(p.id)}</div>
                                    </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            function renderSportSummary(myEntries) {
                const summaryEl = document.getElementById('sport-summary-list');
                if (!summaryEl || !myEntries) return;

                const sportMinutes = {};
                myEntries.forEach(entry => {
                    const sportName = entry.sport;
                    if (!sportMinutes[sportName]) sportMinutes[sportName] = 0;
                    sportMinutes[sportName] += entry.minutes;
                });
                const sortedSports = Object.keys(sportMinutes).sort((a, b) => sportMinutes[b] - sportMinutes[a]);

                summaryEl.innerHTML = sortedSports.map(sport => `
                    <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
                        <span class="text-white font-semibold">${sport}</span>
                        <span class="text-primary font-bold">${sportMinutes[sport]} Min</span>
                    </div>
                `).join('');
            }
            
            function renderRecentActivities(myEntries) {
                const recentActivitiesEl = document.getElementById('recent-activities');
                if (!recentActivitiesEl || !myEntries) return;
                
                const sortedActivities = myEntries.sort((a, b) => (b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp)) - (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp)));
                
                // Begrenze auf die 5 neuesten Aktivitäten
                const limitedActivities = sortedActivities.slice(0, 5);

                if (limitedActivities.length === 0) {
                    recentActivitiesEl.innerHTML = '<p class="text-center text-slate-400 p-4">Keine Aktivitäten gefunden. Trage deine erste Sportart ein!</p>';
                    return;
                }

                recentActivitiesEl.innerHTML = limitedActivities.map(activity => {
                    const date = activity.timestamp.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
                    // Zeige nur das Datum an
                    const dateString = date.toLocaleDateString('de-DE'); 
                    const isMyEntry = activity.userId === userId;
                    const weight = allSports[activity.sport] || 1.0;
                    
                    if (isMyEntry && activity.id === editingDocId) {
                        // Bearbeitungsansicht
                        return `
                            <div class="flex flex-col p-4 bg-slate-800 rounded-lg border border-primary" data-doc-id="${activity.id}">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white font-semibold">Eintrag von ${activity.nickname} bearbeiten</span>
                                    <div class="flex space-x-2">
                                        <button data-action="save" class="text-xs text-accent hover:text-green-400 transition-colors">Speichern</button>
                                        <button data-action="cancel" class="text-xs text-secondary hover:text-red-400 transition-colors">Abbrechen</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <select id="edit-sport-select" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm">
                                        ${Object.keys(allSports).map(sport => 
                                            `<option value="${sport}" ${sport === activity.sport ? 'selected' : ''}>${sport} (x${allSports[sport]})</option>`
                                        ).join('')}
                                    </select>
                                    <input type="number" id="edit-minutes-input" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm" value="${activity.minutes}" min="1">
                                    <input type="date" id="edit-date-input" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm" value="${new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().split('T')[0]}">
                                </div>
                            </div>
                        `;
                    } else {
                        // Normale Ansicht
                        const actionButtons = isMyEntry ? `
                            <div class="flex space-x-2">
                                <button data-action="edit" data-doc-id="${activity.id}" class="text-xs text-slate-400 hover:text-white transition-colors">Bearbeiten</button>
                                <button data-action="delete" data-doc-id="${activity.id}" class="text-xs text-secondary hover:text-red-400 transition-colors">Löschen</button>
                            </div>
                        ` : '';
                        return `
                            <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
                                <div>
                                    <span class="text-white font-semibold">${activity.nickname}</span> hat <span class="text-primary font-bold">${activity.minutes} Min</span>
                                    <span class="text-accent font-semibold">${activity.sport}</span> (${weight}x) gemacht.
                                </div>
                                <div class="flex-shrink-0 text-right">
                                    <span class="text-xs text-slate-500 block mb-1">${dateString}</span>
                                    ${actionButtons}
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                 // Füge eine Notiz hinzu, falls mehr Einträge vorhanden sind
                if (sortedActivities.length > 5) {
                    recentActivitiesEl.innerHTML += '<p class="text-center text-slate-500 mt-4 text-sm">... Es werden nur die neuesten 5 Aktivitäten angezeigt.</p>';
                }
            }
            
            /** Löscht eine benutzerdefinierte Sportart. */
            async function handleDeleteSport(sportName) {
                // Nur benutzerdefinierte Sportarten können gelöscht werden (Standard ist im SPORT_WEIGHTS)
                if (SPORT_WEIGHTS.hasOwnProperty(sportName)) {
                    showToast("Standard-Sportarten können nicht gelöscht werden.", "error");
                    return;
                }
                
                showDynamicModal(
                    "Sportart löschen",
                    `Möchten Sie die Sportart "${sportName}" wirklich unwiderruflich löschen? Zugehörige Einträge behalten die Minuten, aber verlieren ihre Gewichtung.`,
                    [
                        { id: 'confirm-yes-btn', text: 'Ja, löschen', class: 'bg-secondary text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors', onClick: async () => {
                            const userSports = await getUserDefinedSports(userId);
                            delete userSports[sportName];
                            
                            // Speichere die neue Liste der benutzerdefinierten Sportarten in Firestore
                            await saveUserDefinedSports(userSports); 

                            // Lade alle Daten neu, um die UI zu aktualisieren
                            await loadAllData(); 
                            modal.classList.add('hidden');
                            showToast(`Sportart ${sportName} gelöscht.`, 'success');
                        }},
                        { id: 'confirm-no-btn', text: 'Nein', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
                    ]
                );
            }

            // =====================================
            // Event-Listener Setup
            // =====================================
            
            function setupEventListeners() {
                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.addEventListener('click', () => showSection(btn.dataset.section));
                });

                document.getElementById('add-entry-form')?.addEventListener('submit', handleFormSubmit);
                document.getElementById('add-sport-form')?.addEventListener('submit', handleAddSportFormSubmit);

                // Event-Delegation für Minuten-Buttons
                document.querySelector('#add-entry-section')?.addEventListener('click', (e) => {
                    const target = e.target;
                    const minutesInput = document.getElementById('minutes-input');
                    if (target.classList.contains('minutes-btn')) {
                        let currentMinutes = parseInt(minutesInput.value, 10);
                        currentMinutes += parseInt(target.dataset.minutes, 10);
                        minutesInput.value = currentMinutes;
                    } else if (target.id === 'clear-minutes-btn') {
                        minutesInput.value = '0';
                    }
                });

                const sportSelect = document.getElementById('sport-select');
                if (sportSelect) {
                    sportSelect.addEventListener('change', () => {
                        document.getElementById('minutes-input').value = '0';
                    });
                }

                // Event-Delegation für die Liste der letzten Aktivitäten
                document.getElementById('recent-activities')?.addEventListener('click', (e) => {
                    const target = e.target;
                    const docId = target.dataset.docId;
                    const action = target.dataset.action;

                    if (action === 'delete') handleDeleteClick(docId);
                    else if (action === 'edit') handleEditClick(docId);
                    else if (action === 'save') handleSaveEdit(docId);
                    else if (action === 'cancel') handleCancelEdit();
                });

                // Event-Delegation für die Rangliste
                document.getElementById('leaderboard')?.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-user-id]');
                    if (target) showUserProgress(target.dataset.userId);
                });
                
                // Der globale Copy-Button wurde entfernt, da die Sektion verschoben wurde.

                
                // Event Listener für Timeframe (muss neu angehängt werden, da Dashboard neu gerendert wird)
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        chartTimeframe = btn.dataset.timeframe;
                        document.querySelectorAll('.timeframe-btn').forEach(b => {
                            const isSelected = b.dataset.timeframe === chartTimeframe;
                            b.classList.toggle('bg-primary', isSelected);
                            b.classList.toggle('hover:bg-blue-700', isSelected);
                            b.classList.toggle('bg-slate-600', !isSelected);
                            b.classList.toggle('hover:bg-slate-500', !isSelected);
                        });
                        renderDashboardContent();
                    });
                });

                // Setze den initialen Timeframe-Button-Status
                document.querySelectorAll('.timeframe-btn').forEach(b => {
                    const isSelected = b.dataset.timeframe === chartTimeframe;
                    b.classList.toggle('bg-primary', isSelected);
                    b.classList.toggle('hover:bg-blue-700', isSelected);
                    b.classList.toggle('bg-slate-600', !isSelected);
                    b.classList.toggle('hover:bg-slate-500', !isSelected);
                });
            }
            
            // =====================================
            // Formular-Handling
            // =====================================
            async function handleFormSubmit(e) {
                e.preventDefault();
                const sportSelect = document.getElementById('sport-select');
                const dateInput = document.getElementById('date-input');
                const minutesInput = document.getElementById('minutes-input');
                const sport = sportSelect.value;
                const date = dateInput.value;
                const minutes = parseInt(minutesInput.value, 10);

                if (minutes > 0 && date && userId && currentUser) {
                    const newEntry = {
                        userId: userId,
                        nickname: currentUser,
                        sport: sport,
                        minutes: minutes,
                        timestamp: new Date(date)
                    };
                    
                    await addSportEntry(newEntry);
                    
                    minutesInput.value = '0';
                    showSection('dashboard');
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            async function handleAddSportFormSubmit(e) {
                e.preventDefault();
                const newSportNameInput = document.getElementById('new-sport-name');
                const newSportWeightInput = document.getElementById('new-sport-weight');
                const sportName = newSportNameInput.value.trim();
                const sportWeight = parseFloat(newSportWeightInput.value);

                if (sportName && !isNaN(sportWeight) && sportWeight > 0) {
                    // Prüfen, ob die Sportart bereits existiert (entweder Standard oder benutzerdefiniert)
                    if (allSports.hasOwnProperty(sportName)) {
                        showToast("Diese Sportart existiert bereits.", "error");
                        return;
                    }

                    const userSports = await getUserDefinedSports(userId);
                    userSports[sportName] = sportWeight;
                    
                    await saveUserDefinedSports(userSports); // Speichert die aktualisierte Liste
                    
                    showToast("Sportart hinzugefügt!", "success");
                    newSportNameInput.value = '';
                    newSportWeightInput.value = '';
                    
                    await loadAllData();
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie einen gültigen Namen und eine positive Zahl für die Gewichtung ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            // --- CRUD-Funktionen für Einträge ---
            function handleDeleteClick(docId) {
                showDynamicModal(
                    "Eintrag löschen",
                    "Möchten Sie diesen Eintrag wirklich unwiderruflich löschen?",
                    [
                        { id: 'confirm-yes-btn', text: 'Ja', class: 'bg-secondary text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors', onClick: async () => {
                            await deleteSportEntry(docId);
                            modal.classList.add('hidden');
                        }},
                        { id: 'confirm-no-btn', text: 'Nein', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
                    ]
                );
            }

            function handleEditClick(docId) {
                editingDocId = docId;
                renderDashboardContent();
            }

            async function handleSaveEdit(docId) {
                const editedSport = document.getElementById('edit-sport-select').value;
                const editedMinutes = parseInt(document.getElementById('edit-minutes-input').value);
                const editedDate = document.getElementById('edit-date-input').value;
                
                if (editedMinutes > 0 && editedDate) {
                    const newEntry = {
                        sport: editedSport,
                        minutes: editedMinutes,
                        timestamp: new Date(editedDate),
                    };
                    
                    await updateSportEntry(docId, newEntry);
                    
                    editingDocId = null;
                    renderDashboardContent();
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            function handleCancelEdit() {
                editingDocId = null;
                renderDashboardContent();
            }

            // =====================================
            // App-Initialisierung
            // =====================================
            async function migrateDataFromLocalStorage(firebaseUid) {
                appContainer.innerHTML = `<p class="text-center text-slate-400">Migriere lokale Daten...</p>`;
                
                const localStorageUserId = localStorage.getItem('userId');
                const localStorageNickname = localStorage.getItem('nickname');
                const sportEntriesStr = localStorage.getItem('sportEntries');
                
                if (!localStorageUserId || !localStorageNickname || !sportEntriesStr) {
                    console.warn("Lokalstorage-Daten fehlen. Migration wird übersprungen.");
                    await checkUserExistsAndLoad();
                    return;
                }

                try {
                    const entriesToMigrate = JSON.parse(sportEntriesStr).filter(entry => 
                        entry.userId === localStorageUserId && entry.nickname === localStorageNickname
                    );
                    
                    if (entriesToMigrate.length > 0) {
                        const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                        await setDoc(doc(db, leaderboardPath, firebaseUid), { nickname: localStorageNickname, migratedFrom: localStorageUserId }, { merge: true });

                        const privateEntriesPath = `/artifacts/${appId}/users/${firebaseUid}/sportEntries`;
                        const batchPromises = entriesToMigrate.map(entry => {
                            const firestoreEntry = {
                                ...entry,
                                userId: firebaseUid,
                                nickname: localStorageNickname,
                                timestamp: new Date(entry.timestamp)
                            };
                            return addDoc(collection(db, privateEntriesPath), firestoreEntry);
                        });
                        await Promise.all(batchPromises);

                        const userDefinedSportsStr = localStorage.getItem('userDefinedSports');
                        if (userDefinedSportsStr) {
                            const sports = JSON.parse(userDefinedSportsStr);
                            const privateSportsPath = `/artifacts/${appId}/users/${firebaseUid}/userDefinedSports/sportsDoc`;
                            // Filtere Standard-Sportarten heraus, um nur Custom zu speichern
                            const customSportsOnly = Object.keys(sports).reduce((acc, key) => {
                                if (!SPORT_WEIGHTS.hasOwnProperty(key)) {
                                    acc[key] = sports[key];
                                }
                                return acc;
                            }, {});
                            await setDoc(doc(db, privateSportsPath), { sports: customSportsOnly });
                        }
                    
                        showToast("Lokale Daten erfolgreich migriert!", "success");
                    } else {
                         console.warn("Keine zu migrierenden Einträge für diesen Benutzer gefunden.");
                    }
                    
                    localStorage.removeItem('userId');
                    localStorage.removeItem('nickname');
                    localStorage.removeItem('sportEntries');
                    localStorage.removeItem('userDefinedSports');

                } catch (error) {
                    console.error("Fehler bei der Migration:", error);
                    showDynamicModal("Migrationsfehler", "Ein Fehler ist bei der Datenmigration aufgetreten. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
                finally {
                    await loadAllData();
                }
            }

            async function checkUserExistsAndLoad() {
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId);
                try {
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        currentUser = userDoc.data().nickname;
                        await loadAllData();
                        renderApp();
                    } else {
                        renderNicknameForm();
                    }
                } catch (error) {
                    console.error("Fehler beim Laden der Benutzerdaten:", error);
                    showDynamicModal("Fehler", "Benutzerdaten konnten nicht geladen werden. Bitte versuchen Sie es erneut.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            async function startApp() {
                if (!app) {
                    showConfigModal();
                    return;
                }

                if (!auth || !db) {
                    console.error("Firebase Auth oder Firestore Instanz nicht initialisiert.");
                    showDynamicModal("Initialisierungsfehler", "Firebase konnte nicht richtig geladen werden. Überprüfen Sie Ihre Konfiguration.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    return;
                }
                
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error('Authentifizierungsfehler:', error);
                    showDynamicModal("Authentifizierungsfehler", "Konnte mich nicht anmelden. Bitte überprüfen Sie Ihre Internetverbindung.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    return;
                }

                userId = auth.currentUser.uid;
                displayedUserId = userId;

                const hasLocalData = localStorage.getItem('userId') && localStorage.getItem('sportEntries');
                if (hasLocalData) {
                    await migrateDataFromLocalStorage(userId);
                } else {
                    await checkUserExistsAndLoad();
                }
            }

            startApp();
        })(); // <--- Hinzugefügte schließende Klammer
    </script>
</head>
<body class="p-4 sm:p-8">
    <!-- Hauptcontainer für die gesamte App -->
    <div class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl mx-auto border border-slate-700 flex-grow">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-primary mb-2">Sport Challenge 2025/26</h1>
        <p class="text-center text-slate-400 mb-6">Ziel: 8000 Minuten Sport in einem Jahr.</p>

        <!-- Container für die Anmeldemaske oder die Haupt-App -->
        <div id="app-container">
            <p class="text-center text-slate-400">Lade App-Daten...</p>
        </div>
    </div>
    
    <!-- Modales Overlay für Warnungen/Meldungen -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div id="modal-content-wrapper" class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700">
        </div>
    </div>

    <!-- Toast Benachrichtigungs-Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Footer Navigation -->
    <footer class="mt-8">
    </footer>
</body>
</html>



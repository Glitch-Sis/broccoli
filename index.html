<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Challenge App</title>
    <!-- Tailwind CSS CDN für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs - Wir verwenden jetzt die ES-Modul-Versionen -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, where, writeBatch, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        (function() {
            // =====================================
            // Globale Variablen und UI-Elemente
            // =====================================
            const SPORT_WEIGHTS = {
                'Laufen': 1.5,
                'Schwimmen': 1.8,
                'Radfahren': 1.2,
                'Krafttraining': 1.3,
                'Yoga': 0.8,
                'Wandern': 0.9,
                'Step Aerobic': 1.6,
                'HIIT': 1.7,
                'Kayaking': 1.1,
                'Andere': 1.0
            };
            const GOAL_MINUTES = 8000;
            
            const appContainer = document.getElementById('app-container');
            const modal = document.getElementById('message-modal');
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const footerNav = document.querySelector('footer nav');
            
            let userId;
            let currentUser;
            let displayedUserId;
            let myProgressView = 'minutes';
            let chartTimeframe = 'week';
            let allSports = { ...SPORT_WEIGHTS };
            let editingDocId = null;
            let db, auth;
            let unsubscribeFromEntries, unsubscribeFromSports;
            let isAuthReady = false;

            // =====================================
            // Hilfsfunktionen für das Datenmanagement
            // =====================================

            /** Lädt benutzerdefinierte Sportarten aus dem Local Storage. */
            function loadSports() {
                const sports = localStorage.getItem('userDefinedSports');
                return sports ? JSON.parse(sports) : {};
            }

            /** Speichert benutzerdefinierte Sportarten im Local Storage. */
            function saveSports(sports) {
                localStorage.setItem('userDefinedSports', JSON.stringify(sports));
            }
            
            /**
             * Zeigt ein dynamisches modales Fenster mit anpassbarem Titel, Nachricht und Buttons an.
             * @param {string} title - Der Titel des Modals.
             * @param {string} message - Die Nachricht des Modals.
             * @param {Array<Object>} buttons - Ein Array von Button-Konfigurationsobjekten.
             * @param {string} customContent - Optionaler HTML-Inhalt für das Modal.
             */
            function showDynamicModal(title, message, buttons, customContent = null) {
                modalContentWrapper.innerHTML = `
                    <h3 class="text-xl font-bold mb-2 ${title.includes("Fehler") || title.includes("löschen") ? 'text-secondary' : 'text-primary'}">${title}</h3>
                    <p class="text-slate-300 mb-4">${message}</p>
                    ${customContent || ''}
                    <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4" id="modal-buttons"></div>
                `;
                modal.classList.remove('hidden');

                const buttonContainer = document.getElementById('modal-buttons');
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.id = btnConfig.id;
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.class;
                    button.addEventListener('click', btnConfig.onClick);
                    buttonContainer.appendChild(button);
                });
            }

            // =====================================
            // Firebase-Funktionen
            // =====================================
            async function setupFirebase(firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            localStorage.setItem('userId', userId);
                            const userDocRef = doc(db, "users", userId);
                            const userDocSnap = await getDoc(userDocRef);
                            
                            if (userDocSnap.exists()) {
                                currentUser = userDocSnap.data().nickname;
                                localStorage.setItem('nickname', currentUser);
                                displayedUserId = userId;
                                renderApp();
                            } else {
                                renderNicknameForm();
                            }
                            isAuthReady = true;
                            setupFirestoreListeners();
                        } else {
                            // User logged out
                            isAuthReady = false;
                            console.log("Benutzer ist ausgeloggt.");
                        }
                    });
                } catch (error) {
                    console.error("Firebase-Initialisierung fehlgeschlagen:", error);
                    let errorMessage = `Die Initialisierung der Firebase-App ist fehlgeschlagen. Bitte überprüfen Sie Ihre Konfigurationsdaten. Fehler: ${error.message}`;
                    showDynamicModal("Firebase-Fehler", errorMessage, [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    localStorage.removeItem('firebaseConfig');
                    renderFirebaseConfigForm();
                }
            }
            
            /** Richtet die Echtzeit-Listener für Firestore ein. */
            function setupFirestoreListeners() {
                if (unsubscribeFromEntries) unsubscribeFromEntries();
                if (unsubscribeFromSports) unsubscribeFromSports();

                const entriesQuery = query(collection(db, "sportEntries"));
                unsubscribeFromEntries = onSnapshot(entriesQuery, (snapshot) => {
                    const allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI(allEntries);
                }, (error) => {
                    console.error("Fehler beim Abrufen der Einträge: ", error);
                    showDynamicModal("Synchronisationsfehler", `Fehler beim Laden der Daten. Bitte überprüfen Sie Ihre Internetverbindung und Firebase-Regeln.`, [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                });

                const sportsQuery = query(collection(db, "userDefinedSports"));
                unsubscribeFromSports = onSnapshot(sportsQuery, (snapshot) => {
                    const userDefinedSports = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        userDefinedSports[data.sportName] = data.weight;
                    });
                    allSports = { ...SPORT_WEIGHTS, ...userDefinedSports };
                    renderSportSelect();
                    renderSportWeightList();
                }, (error) => {
                    console.error("Fehler beim Abrufen der Sportarten: ", error);
                    showDynamicModal("Synchronisationsfehler", `Fehler beim Laden der Sportarten. Bitte überprüfen Sie Ihre Internetverbindung und Firebase-Regeln.`, [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                });
            }

            /** Löscht alle Firestore-Daten des aktuellen Benutzers. */
            async function deleteAllUserData() {
                if (!userId || !db) return;
                const userEntriesQuery = query(collection(db, "sportEntries"), where("userId", "==", userId));
                const snapshot = await getDocs(userEntriesQuery);
                const batch = writeBatch(db);
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                try {
                    await batch.commit();
                    showDynamicModal("Daten gelöscht", "Alle Ihre Einträge wurden erfolgreich gelöscht.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                } catch (error) {
                    console.error("Fehler beim Löschen der Daten: ", error);
                    showDynamicModal("Fehler", "Ein Fehler ist beim Löschen Ihrer Daten aufgetreten.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            /** Fügt einen neuen Sporteintrag in Firestore hinzu. */
            async function addSportEntry(entry) {
                if (!db) return;
                try {
                    await addDoc(collection(db, "sportEntries"), entry);
                } catch (e) {
                    console.error("Fehler beim Hinzufügen des Dokuments: ", e);
                    showDynamicModal("Fehler", "Fehler beim Speichern des Eintrags.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            /** Aktualisiert einen vorhandenen Sporteintrag in Firestore. */
            async function updateSportEntry(docId, updatedData) {
                if (!db) return;
                try {
                    await updateDoc(doc(db, "sportEntries", docId), updatedData);
                } catch (e) {
                    console.error("Fehler beim Aktualisieren des Dokuments: ", e);
                    showDynamicModal("Fehler", "Fehler beim Aktualisieren des Eintrags.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            /** Löscht einen Sporteintrag in Firestore. */
            async function deleteSportEntry(docId) {
                if (!db) return;
                try {
                    await deleteDoc(doc(db, "sportEntries", docId));
                } catch (e) {
                    console.error("Fehler beim Löschen des Dokuments: ", e);
                    showDynamicModal("Fehler", "Fehler beim Löschen des Eintrags.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            /** Fügt eine neue Sportart in Firestore hinzu. */
            async function addCustomSport(sportName, weight) {
                if (!db) return;
                try {
                    await addDoc(collection(db, "userDefinedSports"), { sportName, weight });
                } catch (e) {
                    console.error("Fehler beim Hinzufügen der Sportart: ", e);
                    showDynamicModal("Fehler", "Fehler beim Speichern der Sportart.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }

            // =====================================
            // UI Rendering und Update Funktionen
            // =====================================

            /** Rendert das Anmeldeformular für den Spitznamen. */
            function renderNicknameForm() {
                appContainer.innerHTML = `
                    <div class="text-center p-6 bg-slate-700 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Willkommen!</h2>
                        <p class="text-slate-300 mb-4">Geben Sie Ihren Spitznamen ein, um zu beginnen.</p>
                        <form id="nickname-form" class="space-y-4">
                            <input type="text" id="nickname-input" placeholder="Ihr Spitzname" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Starten</button>
                        </form>
                    </div>
                `;
                const nicknameForm = document.getElementById('nickname-form');
                const nicknameInput = document.getElementById('nickname-input');
                nicknameForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const nickname = nicknameInput.value.trim();
                    if (nickname) {
                        try {
                            const userDocRef = doc(db, "users", userId);
                            await setDoc(userDocRef, { nickname }, { merge: true });
                            currentUser = nickname;
                            localStorage.setItem('nickname', nickname);
                            renderApp();
                        } catch (error) {
                            console.error("Fehler beim Speichern des Spitznamens: ", error);
                            showDynamicModal("Fehler", "Fehler beim Speichern des Spitznamens.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                        }
                    } else {
                        showDynamicModal("Ungültiger Spitzname", "Bitte geben Sie einen gültigen Spitznamen ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    }
                });
            }

            /** Rendert die Haupt-App. */
            function renderApp() {
                appContainer.innerHTML = `
                    <div class="flex-grow w-full max-w-4xl mx-auto space-y-6">
                        <!-- Navigationsleiste -->
                        <nav class="bg-slate-700 rounded-xl p-2 flex flex-col sm:flex-row justify-start gap-2">
                            <button data-section="dashboard" class="nav-button bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Dashboard</button>
                            <button data-section="add-entry" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Sportart eintragen</button>
                            <button data-section="add-sport" class="nav-button bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Neue Sportart erstellen</button>
                        </nav>
                        <!-- Abschnitt für das Dashboard -->
                        <div id="dashboard-section" class="space-y-6">
                            <!-- Teilnehmer Abschnitt -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Teilnehmer</h2>
                                <div id="leaderboard" class="space-y-4">
                                    <p class="text-center text-slate-400">Lade Rangliste...</p>
                                </div>
                            </div>
                            <!-- Fortschritt Abschnitt -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <h2 class="text-2xl font-bold text-white">Fortschritt</h2>
                                </div>
                                <div class="flex items-center justify-between mb-2 text-sm text-slate-300">
                                    <span id="my-progress-label">Gesammelte Minuten</span>
                                    <span id="my-progress-value">0</span>
                                </div>
                                <div class="flex justify-center mb-4">
                                    <button id="toggle-progress-btn" class="text-sm text-slate-400 py-1 px-3 rounded-full border border-slate-600 hover:bg-slate-600 transition-colors">
                                        Umschalten
                                    </button>
                                </div>
                                
                                <!-- Fortschrittsbalken -->
                                <div class="h-6 bg-slate-800 rounded-full overflow-hidden mb-4 shadow-inner">
                                    <div id="progress-bar" class="h-full bg-accent progress-bar-fill rounded-full" style="width: 0%;"></div>
                                </div>
                                <p id="progress-text" class="text-center text-sm font-semibold text-slate-400"></p>
                                
                                <div class="mt-8">
                                    <h3 class="text-lg font-bold text-white mb-2">Aktivität</h3>
                                    <div class="flex justify-center gap-2 mb-4">
                                        <button data-timeframe="week" class="timeframe-btn bg-primary text-white font-semibold py-1 px-3 rounded-full hover:bg-blue-700 transition-colors">Woche</button>
                                        <button data-timeframe="month" class="timeframe-btn bg-slate-600 text-white font-semibold py-1 px-3 rounded-full hover:bg-slate-500 transition-colors">Monat</button>
                                        <button data-timeframe="year" class="timeframe-btn bg-slate-600 text-white font-semibold py-1 px-3 rounded-full hover:bg-slate-500 transition-colors">Jahr</button>
                                    </div>
                                    <canvas id="weekly-chart" class="w-full h-48"></canvas>
                                </div>
                            </div>
                            <!-- Minuten pro Sportart Auswertung -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Minuten pro Sportart</h2>
                                <div id="sport-summary-list" class="space-y-2">
                                    <!-- Der Inhalt wird hier geladen -->
                                </div>
                            </div>
                            <!-- Letzte Aktivitäten Abschnitt -->
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Letzte Aktivitäten</h2>
                                <div id="recent-activities" class="space-y-4">
                                    <!-- Die Aktivitäten werden hier geladen -->
                                </div>
                            </div>
                        </div>
                        <!-- Abschnitt zum Eintragen von Sport -->
                        <div id="add-entry-section" class="hidden">
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Sportart hinzufügen</h2>
                                <form id="add-entry-form" class="space-y-4">
                                    <div>
                                        <label for="sport-select" class="block text-slate-300 font-semibold mb-1">Sportart</label>
                                        <select id="sport-select" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                            <!-- Sportarten werden hier dynamisch geladen -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="date-input" class="block text-slate-300 font-semibold mb-1">Datum</label>
                                        <input type="date" id="date-input" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <div>
                                        <label for="minutes-input" class="block text-slate-300 font-semibold mb-1">Minuten</label>
                                        <input type="number" id="minutes-input" value="0" min="0" class="w-full p-3 rounded-lg bg-slate-800 text-white text-center text-lg font-bold border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <div class="mt-2 grid grid-cols-3 gap-2">
                                            <button type="button" data-minutes="5" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+5</button>
                                            <button type="button" data-minutes="10" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+10</button>
                                            <button type="button" data-minutes="15" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+15</button>
                                            <button type="button" data-minutes="30" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+30</button>
                                            <button type="button" data-minutes="60" class="minutes-btn w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors">+60</button>
                                            <button type="button" id="clear-minutes-btn" class="w-full bg-secondary text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition-colors">Löschen</button>
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Eintrag hinzufügen</button>
                                </form>
                            </div>
                        </div>
                        <!-- Abschnitt zum Hinzufügen eigener Sportarten -->
                        <div id="add-sport-section" class="hidden">
                            <div class="card bg-slate-700 p-6 rounded-xl">
                                <h2 class="text-2xl font-bold text-white mb-4">Eigene Sportart hinzufügen</h2>
                                <form id="add-sport-form" class="space-y-4">
                                    <div>
                                        <label for="new-sport-name" class="block text-slate-300 font-semibold mb-1">Name der Sportart</label>
                                        <input type="text" id="new-sport-name" placeholder="z.B. Boxen" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <div>
                                        <label for="new-sport-weight" class="block text-slate-300 font-semibold mb-1">Gewichtung (z.B. 1.5)</label>
                                        <input type="number" step="0.1" id="new-sport-weight" placeholder="z.B. 1.5" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Sportart hinzufügen</button>
                                </form>
                                <div class="mt-8">
                                    <h3 class="text-lg font-bold text-white mb-2">Aktuelle Sportarten und Gewichtungen</h3>
                                    <div id="sport-weight-list" class="space-y-2">
                                        <!-- Die Liste wird hier geladen -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const dateInput = document.getElementById('date-input');
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                
                setupEventListeners();
                loadSportsAndData();
                showSection('dashboard');
            }

            /** Zeigt einen bestimmten Abschnitt an und verbirgt die anderen. */
            function showSection(sectionId) {
                document.querySelectorAll('.nav-button').forEach(btn => {
                    const isSelected = btn.dataset.section === sectionId;
                    btn.classList.toggle('bg-primary', isSelected);
                    btn.classList.toggle('hover:bg-blue-700', isSelected);
                    btn.classList.toggle('bg-slate-600', !isSelected);
                    btn.classList.toggle('hover:bg-slate-500', !isSelected);
                });

                document.getElementById('dashboard-section').classList.toggle('hidden', sectionId !== 'dashboard');
                document.getElementById('add-entry-section').classList.toggle('hidden', sectionId !== 'add-entry');
                document.getElementById('add-sport-section').classList.toggle('hidden', sectionId !== 'add-sport');
            }
            
            /** Rendert die Sportarten-Dropdown-Liste neu. */
            function renderSportSelect() {
                const sportSelect = document.getElementById('sport-select');
                if (sportSelect) {
                    sportSelect.innerHTML = Object.keys(allSports).map(sport => 
                        `<option value="${sport}">${sport}</option>`
                    ).join('');
                }
            }
            
            /** Rendert die Liste der Sportarten und ihrer Gewichtungen. */
            function renderSportWeightList() {
                const sportWeightListEl = document.getElementById('sport-weight-list');
                if (!sportWeightListEl) return;
                
                sportWeightListEl.innerHTML = Object.entries(allSports).map(([sport, weight]) => `
                    <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
                        <span class="text-white font-semibold">${sport}</span>
                        <span class="text-primary font-bold">Gewichtung: ${weight}</span>
                    </div>
                `).join('');
            }

            /** Zeigt den Fortschritt eines bestimmten Benutzers an. */
            function showUserProgress(selectedUserId) {
                displayedUserId = selectedUserId;
                updateUI([]);
            }

            /** Aktualisiert die gesamte Benutzeroberfläche. */
            function updateUI(allEntries) {
                renderMyProgress(allEntries);
                renderLeaderboard(allEntries);
                renderSportSummary(allEntries);
                renderRecentActivities(allEntries);
            }

            function renderMyProgress(data) {
                const myProgressLabelEl = document.getElementById('my-progress-label');
                const myProgressValueEl = document.getElementById('my-progress-value');
                const progressBarEl = document.getElementById('progress-bar');
                const progressTextEl = document.getElementById('progress-text');

                if (!myProgressLabelEl || !myProgressValueEl || !progressBarEl || !progressTextEl || !data) return;

                const myEntries = data.filter(entry => entry.userId === displayedUserId);
                const totalMinutes = myEntries.reduce((sum, entry) => sum + entry.minutes, 0);
                const totalWeightedMinutes = myEntries.reduce((sum, entry) => {
                    const weight = allSports[entry.sport] || 1.0;
                    return sum + (entry.minutes * weight);
                }, 0);

                let displayValue = (myProgressView === 'minutes') ? totalMinutes : totalWeightedMinutes;
                let progress = (displayValue / GOAL_MINUTES) * 100;
                
                myProgressLabelEl.textContent = (myProgressView === 'minutes') ? 'Gesammelte Minuten' : 'Gewichtete Minuten';
                myProgressValueEl.textContent = displayValue.toFixed(myProgressView === 'weighted' ? 1 : 0);
                progressBarEl.style.width = `${Math.min(100, progress)}%`;
                progressTextEl.textContent = `Fortschritt: ${progress.toFixed(1)}%`;

                if (progress >= 100) {
                    progressBarEl.classList.remove('bg-accent');
                    progressBarEl.classList.add('bg-primary', 'animate-pulse-slow');
                    progressTextEl.textContent = "Ziel erreicht! Herzlichen Glückwunsch! 🎉";
                } else {
                    progressBarEl.classList.remove('bg-primary', 'animate-pulse-slow');
                    progressBarEl.classList.add('bg-accent');
                }

                renderWeeklyProgressGraph(myEntries);
            }
            
            function renderWeeklyProgressGraph(myEntries) {
                const canvas = document.getElementById('weekly-chart');
                if (!canvas || !myEntries) return;

                const containerWidth = canvas.parentElement.clientWidth;
                canvas.width = containerWidth;
                canvas.height = 192;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let dataPoints = [];
                let labels = [];

                const now = new Date();
                if (chartTimeframe === 'week') {
                    const dailyMinutes = new Array(7).fill(0);
                    const oneWeekAgo = now.getTime() - 7 * 24 * 60 * 60 * 1000;
                    myEntries.filter(entry => new Date(entry.timestamp).getTime() > oneWeekAgo)
                        .forEach(entry => {
                            const entryDate = new Date(entry.timestamp);
                            const diffDays = Math.floor((now.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24));
                            if (diffDays >= 0 && diffDays < 7) dailyMinutes[6 - diffDays] += entry.minutes;
                        });
                    dataPoints = dailyMinutes;
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(now.getDate() - i);
                        labels.push(date.toLocaleDateString('de-DE', { weekday: 'short' }));
                    }
                } else if (chartTimeframe === 'month') {
                    const weeklyMinutes = new Array(4).fill(0);
                    const oneMonthAgo = now.getTime() - 30 * 24 * 60 * 60 * 1000;
                    myEntries.filter(entry => new Date(entry.timestamp).getTime() > oneMonthAgo)
                        .forEach(entry => {
                            const entryDate = new Date(entry.timestamp);
                            const diffDays = Math.floor((now.getTime() - entryDate.getTime()) / (1000 * 60 * 60 * 24));
                            const weekIndex = Math.floor(diffDays / 7);
                            if (weekIndex >= 0 && weekIndex < 4) weeklyMinutes[3 - weekIndex] += entry.minutes;
                        });
                    dataPoints = weeklyMinutes;
                    labels = ['Woche 1', 'Woche 2', 'Woche 3', 'Woche 4'];
                } else if (chartTimeframe === 'year') {
                    const monthlyMinutes = new Array(12).fill(0);
                    const oneYearAgo = now.getTime() - 365 * 24 * 60 * 60 * 1000;
                    myEntries.filter(entry => new Date(entry.timestamp).getTime() > oneYearAgo)
                        .forEach(entry => {
                            const entryDate = new Date(entry.timestamp);
                            const diffMonths = (now.getFullYear() - entryDate.getFullYear()) * 12 + (now.getMonth() - entryDate.getMonth());
                            if (diffMonths >= 0 && diffMonths < 12) monthlyMinutes[11 - diffMonths] += entry.minutes;
                        });
                    dataPoints = monthlyMinutes;
                    for (let i = 11; i >= 0; i--) {
                        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        labels.push(monthDate.toLocaleDateString('de-DE', { month: 'short' }));
                    }
                }
                
                const maxMinutes = Math.max(...dataPoints, 1);
                const padding = 30;
                const chartHeight = canvas.height - 2 * padding;
                const chartWidth = canvas.width - 2 * padding;
                const pointSpacing = chartWidth / (dataPoints.length > 1 ? dataPoints.length - 1 : 1);

                ctx.beginPath();
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 3;
                const points = dataPoints.map((value, index) => ({
                    x: padding + index * pointSpacing,
                    y: padding + chartHeight - (value / maxMinutes) * chartHeight
                }));
                if (points.length > 0) {
                    ctx.moveTo(points[0].x, points[0].y);
                    points.forEach(point => ctx.lineTo(point.x, point.y));
                }
                ctx.stroke();
                
                ctx.textAlign = 'right';
                ctx.fillStyle = '#94a3b8';
                ctx.font = '10px Inter';
                const yLabels = [0, Math.floor(maxMinutes / 2), maxMinutes];
                yLabels.forEach(label => {
                    const y = padding + chartHeight - (label / maxMinutes) * chartHeight;
                    ctx.fillText(label, padding - 5, y + 4);
                });
                
                points.forEach(point => {
                    ctx.beginPath();
                    ctx.fillStyle = '#22c55e';
                    ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                });

                ctx.fillStyle = '#f3f4f6';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                labels.forEach((label, index) => {
                    const x = padding + index * pointSpacing;
                    ctx.fillStyle = '#94a3b8';
                    ctx.fillText(label, x, canvas.height - 5);
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillText(dataPoints[index], x, points[index].y - 10);
                });
            }

            function renderLeaderboard(data) {
                const leaderboardEl = document.getElementById('leaderboard');
                if (!leaderboardEl || !data) return;

                const participants = {};
                data.forEach(entry => {
                    const userKey = entry.userId;
                    if (!participants[userKey]) {
                        participants[userKey] = {
                            userId: userKey,
                            nickname: entry.nickname,
                            minutes: 0,
                            weightedMinutes: 0
                        };
                    }
                    const weight = allSports[entry.sport] || 1.0;
                    participants[userKey].minutes += entry.minutes;
                    participants[userKey].weightedMinutes += entry.minutes * weight;
                });

                let participantArray = Object.values(participants);

                participantArray.sort((a, b) => b.minutes - a.minutes);
                const minutesLeader = participantArray[0] || { minutes: -1, userId: null };
                participantArray.sort((a, b) => b.weightedMinutes - a.weightedMinutes);
                const weightedLeader = participantArray[0] || { weightedMinutes: -1, userId: null };

                const loggedInUser = participantArray.find(p => p.userId === userId);
                let sortedParticipants = loggedInUser ? [loggedInUser, ...participantArray.filter(p => p.userId !== userId)] : participantArray;

                leaderboardEl.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-4">
                        ${sortedParticipants.map(p => {
                            const isMinutesLeader = p.userId === minutesLeader.userId;
                            const isWeightedLeader = p.userId === weightedLeader.userId;
                            const isActiveUser = p.userId === displayedUserId;
                            
                            return `
                                <div data-user-id="${p.userId}" class="flex-1 p-6 rounded-xl border-2 cursor-pointer transition-all duration-200 ease-in-out ${isActiveUser ? 'border-primary' : 'border-slate-600'} bg-slate-800 text-center relative overflow-hidden hover:scale-105">
                                    <h3 class="text-xl font-bold mb-2 text-white">
                                        ${p.nickname}
                                        ${p.userId === userId ? ' (Du)' : ''}
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="p-3 rounded-lg bg-slate-700">
                                            <div class="text-slate-400 text-sm">Gesammelte Minuten</div>
                                            <div class="text-2xl font-extrabold ${isMinutesLeader ? 'text-primary' : 'text-white'}">
                                                ${p.minutes.toFixed(0)}
                                                ${isMinutesLeader ? '<span class="text-xs ml-1">🏆</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-slate-700">
                                            <div class="text-slate-400 text-sm">Gewichtete Minuten</div>
                                            <div class="text-2xl font-extrabold ${isWeightedLeader ? 'text-accent' : 'text-white'}">
                                                ${p.weightedMinutes.toFixed(1)}
                                                ${isWeightedLeader ? '<span class="text-xs ml-1">🏆</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-sm text-slate-500 mt-2">${p.userId}</div>
                                    </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            function renderSportSummary(data) {
                const summaryEl = document.getElementById('sport-summary-list');
                if (!summaryEl || !data) return;

                const myEntries = data.filter(entry => entry.userId === displayedUserId);
                const sportMinutes = {};
                myEntries.forEach(entry => {
                    const sportName = entry.sport;
                    if (!sportMinutes[sportName]) sportMinutes[sportName] = 0;
                    sportMinutes[sportName] += entry.minutes;
                });
                const sortedSports = Object.keys(sportMinutes).sort((a, b) => sportMinutes[b] - sportMinutes[a]);

                summaryEl.innerHTML = sortedSports.map(sport => `
                    <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
                        <span class="text-white font-semibold">${sport}</span>
                        <span class="text-primary font-bold">${sportMinutes[sport]} Minuten</span>
                    </div>
                `).join('');
            }
            
            function renderRecentActivities(data) {
                const recentActivitiesEl = document.getElementById('recent-activities');
                if (!recentActivitiesEl || !data) return;

                const displayedActivities = data.filter(entry => entry.userId === displayedUserId);
                const sortedActivities = displayedActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                recentActivitiesEl.innerHTML = sortedActivities.map(activity => {
                    const date = new Date(activity.timestamp);
                    const dateString = date.toLocaleDateString('de-DE');
                    const timeString = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const isMyEntry = activity.userId === userId;
                    
                    if (isMyEntry && activity.id === editingDocId) {
                        return `
                            <div class="flex flex-col p-4 bg-slate-800 rounded-lg border border-primary" data-id="${activity.id}">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white font-semibold">Eintrag von ${activity.nickname} bearbeiten</span>
                                    <div class="flex space-x-2">
                                        <button data-action="save" data-id="${activity.id}" class="text-xs text-accent hover:text-green-400 transition-colors">Speichern</button>
                                        <button data-action="cancel" class="text-xs text-secondary hover:text-red-400 transition-colors">Abbrechen</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <select id="edit-sport-select" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm">
                                        ${Object.keys(allSports).map(sport => 
                                            `<option value="${sport}" ${sport === activity.sport ? 'selected' : ''}>${sport}</option>`
                                        ).join('')}
                                    </select>
                                    <input type="number" id="edit-minutes-input" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm" value="${activity.minutes}" min="1">
                                    <input type="date" id="edit-date-input" class="w-full p-2 rounded-lg bg-slate-700 text-white text-sm" value="${activity.timestamp.split('T')[0]}">
                                </div>
                            </div>
                        `;
                    } else {
                        const actionButtons = isMyEntry ? `
                            <div class="flex space-x-2">
                                <button data-action="edit" data-id="${activity.id}" class="text-xs text-slate-400 hover:text-white transition-colors">Bearbeiten</button>
                                <button data-action="delete" data-id="${activity.id}" class="text-xs text-secondary hover:text-red-400 transition-colors">Löschen</button>
                            </div>
                        ` : '';
                        return `
                            <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-600">
                                <div>
                                    <span class="text-white font-semibold">${activity.nickname}</span> hat <span class="text-primary font-bold">${activity.minutes} Minuten</span>
                                    <span class="text-accent font-semibold">${activity.sport}</span> gemacht.
                                </div>
                                <div class="flex-shrink-0 text-right">
                                    <span class="text-xs text-slate-500 block mb-1">${dateString} ${timeString}</span>
                                    ${actionButtons}
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            
            // =====================================
            // Event-Listener Setup
            // =====================================
            
            function setupEventListeners() {
                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.addEventListener('click', () => showSection(btn.dataset.section));
                });

                document.getElementById('add-entry-form')?.addEventListener('submit', handleFormSubmit);
                document.getElementById('add-sport-form')?.addEventListener('submit', handleAddSportFormSubmit);
                document.getElementById('toggle-progress-btn')?.addEventListener('click', () => {
                    myProgressView = myProgressView === 'minutes' ? 'weighted' : 'minutes';
                    updateUI([]);
                });

                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        chartTimeframe = btn.dataset.timeframe;
                        document.querySelectorAll('.timeframe-btn').forEach(b => {
                            const isSelected = b.dataset.timeframe === chartTimeframe;
                            b.classList.toggle('bg-primary', isSelected);
                            b.classList.toggle('hover:bg-blue-700', isSelected);
                            b.classList.toggle('bg-slate-600', !isSelected);
                            b.classList.toggle('hover:bg-slate-500', !isSelected);
                        });
                        
                    });
                });

                document.querySelector('#add-entry-section')?.addEventListener('click', (e) => {
                    const target = e.target;
                    const minutesInput = document.getElementById('minutes-input');
                    if (target.classList.contains('minutes-btn')) {
                        let currentMinutes = parseInt(minutesInput.value, 10);
                        currentMinutes += parseInt(target.dataset.minutes, 10);
                        minutesInput.value = currentMinutes;
                    } else if (target.id === 'clear-minutes-btn') {
                        minutesInput.value = '0';
                    }
                });

                const sportSelect = document.getElementById('sport-select');
                if (sportSelect) {
                    sportSelect.addEventListener('change', () => {
                        document.getElementById('minutes-input').value = '0';
                    });
                }

                document.getElementById('recent-activities')?.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-id], [data-action]');
                    if (!target) return;
                    
                    const id = target.dataset.id;
                    const action = target.dataset.action;

                    if (action === 'delete') handleDeleteClick(id);
                    else if (action === 'edit') handleEditClick(id);
                    else if (action === 'save') handleSaveEdit(id);
                    else if (action === 'cancel') handleCancelEdit();
                });

                document.getElementById('leaderboard')?.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-user-id]');
                    if (target) showUserProgress(target.dataset.userId);
                });

                footerNav?.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (target && target.id === 'data-sync-btn') {
                        renderDataSyncModal();
                    }
                });
            }

            // =====================================
            // Formular-Handling
            // =====================================
            async function handleFormSubmit(e) {
                e.preventDefault();
                const sportSelect = document.getElementById('sport-select');
                const dateInput = document.getElementById('date-input');
                const minutesInput = document.getElementById('minutes-input');
                const sport = sportSelect.value;
                const date = dateInput.value;
                const minutes = parseInt(minutesInput.value, 10);

                if (minutes > 0 && date && userId && currentUser) {
                    const newEntry = {
                        userId: userId,
                        nickname: currentUser,
                        sport: sport,
                        minutes: minutes,
                        timestamp: new Date(date).toISOString()
                    };
                    await addSportEntry(newEntry);
                    minutesInput.value = '0';
                    showSection('dashboard');
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            async function handleAddSportFormSubmit(e) {
                e.preventDefault();
                const newSportNameInput = document.getElementById('new-sport-name');
                const newSportWeightInput = document.getElementById('new-sport-weight');
                const sportName = newSportNameInput.value.trim();
                const sportWeight = parseFloat(newSportWeightInput.value);

                if (sportName && !isNaN(sportWeight) && sportWeight > 0) {
                    await addCustomSport(sportName, sportWeight);
                    showDynamicModal("Sportart hinzugefügt", `Die Sportart "${sportName}" wurde erfolgreich erstellt.`, [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                    newSportNameInput.value = '';
                    newSportWeightInput.value = '';
                } else {
                    showDynamicModal("Ungültige Eingabe", "Bitte geben Sie einen gültigen Namen und eine positive Zahl für die Gewichtung ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                }
            }
            
            // --- CRUD-Funktionen für Einträge ---
            function handleDeleteClick(docId) {
                showDynamicModal(
                    "Eintrag löschen",
                    "Möchten Sie diesen Eintrag wirklich unwiderruflich löschen?",
                    [
                        { id: 'confirm-yes-btn', text: 'Ja', class: 'bg-secondary text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors', onClick: async () => {
                            await deleteSportEntry(docId);
                            modal.classList.add('hidden');
                        }},
                        { id: 'confirm-no-btn', text: 'Nein', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
                        ]
                        );
                    }
                    
                    function handleEditClick(docId) {
                        editingDocId = docId;
                        updateUI([]);
                    }
                    
                    async function handleSaveEdit(docId) {
                        const editedSport = document.getElementById('edit-sport-select').value;
                        const editedMinutes = parseInt(document.getElementById('edit-minutes-input').value);
                        const editedDate = document.getElementById('edit-date-input').value;
                        
                        if (editedMinutes > 0 && editedDate) {
                            const updatedData = {
                                sport: editedSport,
                                minutes: editedMinutes,
                                timestamp: new Date(editedDate).toISOString()
                            };
                            await updateSportEntry(docId, updatedData);
                            editingDocId = null;
                        } else {
                            showDynamicModal("Ungültige Eingabe", "Bitte geben Sie eine positive Minutenzahl und ein Datum ein.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                        }
                    }
                    
                    function handleCancelEdit() {
                        editingDocId = null;
                        updateUI([]);
                    }
                    
                    // =====================================
                    // Daten-Sync-Funktionen
                    // =====================================
                    
                    async function migrateLocalDataToFirestore() {
                        const localEntries = JSON.parse(localStorage.getItem('sportEntries') || '[]');
                        const localSports = JSON.parse(localStorage.getItem('userDefinedSports') || '{}');
                        const localNickname = localStorage.getItem('nickname');

                        if (localEntries.length === 0 && Object.keys(localSports).length === 0 && !localNickname) {
                            showDynamicModal("Keine Daten gefunden", "Es gibt keine lokalen Daten zu migrieren.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                            return;
                        }
                        
                        const batch = writeBatch(db);

                        // Migriere den Spitznamen, wenn er im localStorage existiert
                        if (localNickname) {
                            const userDocRef = doc(db, "users", userId);
                            batch.set(userDocRef, { nickname: localNickname }, { merge: true });
                        }

                        // Migriere benutzerdefinierte Sportarten
                        for (const sportName in localSports) {
                            const newDocRef = doc(collection(db, "userDefinedSports"));
                            batch.set(newDocRef, { sportName, weight: localSports[sportName] });
                        }

                        // Migriere Sporteinträge
                        localEntries.forEach(entry => {
                            const newDocRef = doc(collection(db, "sportEntries"));
                            batch.set(newDocRef, { ...entry, userId: userId }); // Stelle sicher, dass die richtige userId verwendet wird
                        });

                        try {
                            await batch.commit();
                            // Lösche die lokalen Daten nach erfolgreicher Migration
                            localStorage.removeItem('sportEntries');
                            localStorage.removeItem('userDefinedSports');
                            localStorage.removeItem('nickname');
                            localStorage.removeItem('userId');

                            showDynamicModal("Migration erfolgreich", "Alle lokalen Daten wurden erfolgreich in die Datenbank migriert. Die Seite wird neu geladen.", [{ id: 'reload-btn', text: 'Seite neu laden', class: 'w-full bg-accent text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition-colors', onClick: () => window.location.reload() }]);
                        } catch (error) {
                            console.error("Fehler bei der Datenmigration: ", error);
                            showDynamicModal("Fehler bei der Migration", `Ein Fehler ist aufgetreten: ${error.message}`, [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                        }
                    }

                    /** Zeigt das Modal-Fenster für Daten-Sync an. */
                    function renderDataSyncModal() {
                        const isShareAvailable = navigator.canShare && navigator.canShare({ files: [new File([], 'test.json', { type: 'application/json' })] });
                        
                        const customContent = `
                            <div class="space-y-4">
                                <button id="migrate-btn" class="w-full bg-accent text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition-colors">
                                    <span class="flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                            <path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v11.69l3.44-3.44a.75.75 0 111.06 1.06l-4.75 4.75a.75.75 0 01-1.06 0l-4.75-4.75a.75.75 0 011.06-1.06l3.44 3.44V3a.75.75 0 01.75-.75zM17.25 18a.75.75 0 010 1.5H6.75a.75.75 0 010-1.5h10.5z" clip-rule="evenodd" />
                                        </svg>
                                        <span>Lokale Daten migrieren</span>
                                    </span>
                                </button>
                                <button id="export-file-btn" class="w-full bg-accent text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition-colors">
                                    <span class="flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                            <path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v11.69l3.44-3.44a.75.75 0 111.06 1.06l-4.75 4.75a.75.75 0 01-1.06 0l-4.75-4.75a.75.75 0 011.06-1.06l3.44 3.44V3a.75.75 0 01.75-.75zM17.25 18a.75.75 0 010 1.5H6.75a.75.75 0 010-1.5h10.5z" clip-rule="evenodd" />
                                        </svg>
                                        <span>Daten als JSON exportieren</span>
                                    </span>
                                </button>
                                <button id="share-data-btn" class="w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors ${!isShareAvailable ? 'hidden' : ''}">
                                    <span class="flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                            <path fill-rule="evenodd" d="M15.75 4.5a3 3 0 11.825 2.572 2.542 2.542 0 01-.825 3.016V12a.75.75 0 001.5 0v-1.912a4.05 4.05 0 001.89-1.396A3 3 0 1115.75 4.5zM18 18a3 3 0 11-5.69 1.341c-.675-.152-1.385-.295-2.1-.42V4.5a3 3 0 11.825-2.288 4.05 4.05 0 00-1.89 1.396V12a.75.75 0 001.5 0v-.855c.715.125 1.425.268 2.1.42A3 3 0 1118 18zM3.75 6.75a3 3 0 116 0 3 3 0 01-6 0z" clip-rule="evenodd" />
                                        </svg>
                                        <span>Daten teilen</span>
                                    </span>
                                </button>
                            </div>
                            <div class="mt-6">
                                <label class="block text-slate-300 mb-2">Konfiguration ändern</label>
                                <textarea id="firebase-config-input" rows="5" class="w-full p-2 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Fügen Sie hier Ihr Firebase-Konfigurations-JSON ein"></textarea>
                                <button id="save-config-btn" class="w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors mt-2">
                                    Konfiguration speichern
                                </button>
                            </div>
                            <div class="mt-6">
                                <button id="clear-data-btn" class="w-full bg-secondary text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition-colors">Alle meine Einträge löschen</button>
                            </div>
                        `;
                        
                        showDynamicModal(
                            "Daten Sync & Verwaltung",
                            "Sichern, teilen oder verwalten Sie Ihre Daten.",
                            [{ id: 'modal-close-btn', text: 'Schließen', class: 'w-full bg-slate-600 text-white font-semibold py-2 rounded-lg hover:bg-slate-500 transition-colors mt-6', onClick: () => modal.classList.add('hidden') }],
                            customContent
                            );
                            
                            document.getElementById('migrate-btn').addEventListener('click', () => {
                                modal.classList.add('hidden');
                                migrateLocalDataToFirestore();
                            });

                            document.getElementById('export-file-btn').addEventListener('click', async () => {
                                const entriesQuery = query(collection(db, "sportEntries"), where("userId", "==", userId));
                                const snapshot = await getDocs(entriesQuery);
                                const entries = snapshot.docs.map(doc => doc.data());
                                const data = { sportEntries: entries, userDefinedSports: loadSports() };
                                const dataStr = JSON.stringify(data, null, 2);
                                const blob = new Blob([dataStr], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `sport-challenge-data-${new Date().toISOString().split('T')[0]}.json`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                                showDynamicModal("Export erfolgreich", "Ihre Daten wurden als JSON-Datei exportiert.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                            });
                            
                            document.getElementById('share-data-btn').addEventListener('click', async () => {
                                const entriesQuery = query(collection(db, "sportEntries"), where("userId", "==", userId));
                                const snapshot = await getDocs(entriesQuery);
                                const entries = snapshot.docs.map(doc => doc.data());
                                const data = { sportEntries: entries, userDefinedSports: loadSports() };
                                const dataStr = JSON.stringify(data, null, 2);
                                const blob = new Blob([dataStr], { type: 'application/json' });
                                const file = new File([blob], `sport-challenge-data-${new Date().toISOString().split('T')[0]}.json`, { type: 'application/json' });
                                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                    await navigator.share({ title: 'Meine Sport Challenge Daten', text: 'Hier sind meine Sportdaten aus der Sport Challenge App.', files: [file] });
                                }
                            });
                            
                            document.getElementById('save-config-btn').addEventListener('click', () => {
                                const configText = document.getElementById('firebase-config-input').value;
                                try {
                                    let cleanedConfig = configText;
                                    if (cleanedConfig.startsWith('const firebaseConfig =')) {
                                        cleanedConfig = cleanedConfig.substring('const firebaseConfig ='.length).trim();
                                    }
                                    const parsedConfig = (new Function('return ' + cleanedConfig))();
                                    localStorage.setItem('firebaseConfig', JSON.stringify(parsedConfig));
                                    initializeAppWithConfig(parsedConfig);
                                    modal.classList.add('hidden');
                                } catch (e) {
                                    showDynamicModal("Fehler", "Ungültiges Format. Bitte kopieren Sie Ihre Firebase-Konfiguration genau so, wie sie Ihnen in der Konsole angezeigt wird.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                                }
                            });
                            
                            document.getElementById('clear-data-btn').addEventListener('click', () => {
                                showDynamicModal(
                                    "Daten löschen",
                                    "Möchten Sie wirklich alle Ihre Einträge unwiderruflich löschen?",
                                    [
                                        { id: 'confirm-yes-btn', text: 'Ja', class: 'bg-secondary text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors', onClick: async () => {
                                            await deleteAllUserData();
                                            modal.classList.add('hidden');
                                        }},
                                        { id: 'confirm-no-btn', text: 'Nein', class: 'bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors', onClick: () => modal.classList.add('hidden') }
                                    ]
                                    );
                                });
                            }
                            
                            // =====================================
                            // App-Initialisierung
                            // =====================================
                            function initializeApp() {
                                const firebaseConfigString = localStorage.getItem('firebaseConfig');
                                if (firebaseConfigString) {
                                    try {
                                        const firebaseConfig = JSON.parse(firebaseConfigString);
                                        initializeAppWithConfig(firebaseConfig);
                                    } catch (e) {
                                        console.error("Gespeicherte Firebase-Konfiguration ist ungültig.", e);
                                        localStorage.removeItem('firebaseConfig');
                                        renderFirebaseConfigForm();
                                    }
                                } else {
                                    renderFirebaseConfigForm();
                                }
                            }
                            
                            function initializeAppWithConfig(config) {
                                renderLoadingScreen();
                                setupFirebase(config);
                            }

                            function renderLoadingScreen() {
                                appContainer.innerHTML = `
                                    <p class="text-center text-slate-400">Verbinde mit Firebase...</p>
                                `;
                            }
                            
                            function renderFirebaseConfigForm() {
                                appContainer.innerHTML = `
                                    <div class="text-center p-6 bg-slate-700 rounded-xl">
                                        <h2 class="text-2xl font-semibold mb-4 text-white">Datenbank verknüpfen</h2>
                                        <p class="text-slate-300 mb-4">Fügen Sie Ihre Firebase-Konfiguration als JavaScript-Objekt ein. Sie finden diese in den Projekteinstellungen Ihrer Firebase-Konsole.</p>
                                        <form id="config-form" class="space-y-4">
                                            <textarea id="firebase-config-input" rows="10" placeholder="const firebaseConfig = {
  apiKey: &quot;...&quot;,
  authDomain: &quot;...&quot;,
  projectId: &quot;...&quot;,
  storageBucket: &quot;...&quot;,
  messagingSenderId: &quot;...&quot;,
  appId: &quot;...&quot;,
  measurementId: &quot;...&quot;
};" class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                                            <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors">Verbinden</button>
                                        </form>
                                    </div>
                                `;
                                const configForm = document.getElementById('config-form');
                                configForm.addEventListener('submit', (e) => {
                                    e.preventDefault();
                                    const configInput = document.getElementById('firebase-config-input').value.trim();
                                    try {
                                        let cleanedConfig = configInput;
                                        if (cleanedConfig.startsWith('const firebaseConfig =')) {
                                            cleanedConfig = cleanedConfig.substring('const firebaseConfig ='.length).trim();
                                        }
                                        const parsedConfig = (new Function('return ' + cleanedConfig))();
                                        localStorage.setItem('firebaseConfig', JSON.stringify(parsedConfig));
                                        initializeAppWithConfig(parsedConfig);
                                    } catch (error) {
                                        showDynamicModal("Ungültige Eingabe", "Das eingegebene Format ist ungültig. Bitte kopieren Sie Ihre Firebase-Konfiguration genau so, wie sie Ihnen in der Konsole angezeigt wird.", [{ id: 'modal-close-btn', text: 'OK', class: 'w-full bg-primary text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors', onClick: () => modal.classList.add('hidden') }]);
                                    }
                                });
                            }
                            
                            document.addEventListener('DOMContentLoaded', initializeApp);
                            
                            })(); // Schließe die selbstausführende Funktion
                            </script>
                        </head>
                        <body class="p-4 sm:p-8">
                            <!-- Hauptcontainer für die gesamte App -->
                            <div class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-4xl mx-auto border border-slate-700 flex-grow">
                                <h1 class="text-3xl sm:text-4xl font-bold text-center text-primary mb-2">Sport Challenge 2025/26</h1>
                                <p class="text-center text-slate-400 mb-6">Erreiche 8000 Minuten Sport in einem Jahr.</p>
                                
                                <!-- Container für die Anmeldemaske oder die Haupt-App -->
                                <div id="app-container">
                                    <p class="text-center text-slate-400">Lade App-Daten...</p>
                                </div>
                            </div>
                            
                            <!-- Modales Overlay für Warnungen/Meldungen -->
                            <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                                <div id="modal-content-wrapper" class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700">
                                </div>
                            </div>
                            
                            <!-- Footer Navigation -->
                            <footer class="mt-8">
                                <nav>
                                    <button id="data-sync-btn" class="text-primary font-semibold py-2 px-4 rounded-lg hover:text-blue-400 transition-colors">Daten Sync</button>
                                </nav>
                            </footer>
                        </body>
                        </html>

